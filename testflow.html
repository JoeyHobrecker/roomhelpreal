<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager - Task & Project Manager</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&amp;display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="dexie.min.js" defer></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js" defer></script>

    <style>
        :root {
            --sapphire: #4F7FFF; /* Accent */
            --lavender: #9E7BFF; /* Warning / Secondary Accent */
            --mint: #5FF1C6;     /* Success / Active */
            --charcoal: #20232A; /* Primary Background */
            --offwhite: #F9FAFB; /* Primary Text */

            --primary-color: var(--charcoal); 
            --secondary-color: #2b2e36; 
            --accent-color: var(--sapphire);
            --text-color: var(--offwhite);
            --light-text: #dfe3e8; 
            --border-color: #3b4252; /* Slightly lighter than secondary for subtle borders */
            --input-bg-color: #1a1d23; /* Darker for inputs */
            --success-color: var(--mint);
            --warning-color: var(--lavender);
            --danger-color: #FF647C; 
            --storage-color: #6c757d; 
            --completed-color: #88c0d0; /* Nord Frost 3 */
            --active-color: var(--mint); /* Using mint for active status */
            --waiting-color: var(--lavender); /* Using lavender for waiting status */


            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.2);
            
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;

            --transition-fast: all 0.15s ease-in-out;
            --transition-std: all 0.25s ease-in-out;

            --sapphire-rgb: 79, 127, 255;
            --mint-rgb: 95, 241, 198;
            --charcoal-rgb: 32, 35, 42;
            --lavender-rgb: 158, 123, 255;

        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            color: var(--text-color); 
            background-color: var(--primary-color); 
            line-height: 1.6;
            font-size: 15px;
        }
        h1,h2,h3,h4,h5,h6 { font-family: 'Poppins', sans-serif; color: var(--offwhite); font-weight: 600; }
        h1 { font-size: 2.2em; } h2 { font-size: 1.8em; } h3 { font-size: 1.5em; } h4 { font-size: 1.2em; }
        a { color: var(--accent-color); text-decoration: none; transition: var(--transition-fast); }
        a:hover { color: var(--mint); }
        button { font-family: inherit; cursor: pointer; }
        input, select, textarea { font-family: inherit; font-size: inherit; }

        .app-container { max-width: 1400px; margin: 0 auto; padding: 25px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes expandIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        .task-complete-animation { animation: expandOut 0.5s ease forwards; }
        @keyframes expandOut { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.9); height: 0; padding-top:0; padding-bottom:0; margin-bottom:0; border-width:0;} }


        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            animation: fadeIn 0.5s var(--transition-std);
        }
        .logo-wrapper { display:flex; align-items:center; gap:12px; }
        .logo-img { height:40px; width:auto; border-radius:var(--border-radius-sm); }
        .logo-text { font-weight:700; font-size:26px; color:var(--offwhite); }

        .view-controls { display: flex; flex-wrap: wrap; gap: 10px; }
        .view-btn {
            background-color: var(--secondary-color);
            color: var(--light-text);
            border: 1px solid var(--border-color);
            padding: 10px 18px;
            border-radius: var(--border-radius-sm);
            transition: var(--transition-std);
            font-size: 14px;
            font-weight: 500;
        }
        .view-btn:hover {
            background-color: var(--accent-color);
            color: var(--offwhite);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .view-btn.active {
            background-color: var(--accent-color);
            color: var(--offwhite);
            font-weight: 600;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1), var(--shadow-sm);
        }

        /* Main Layout */
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 30px; animation: fadeIn 0.5s ease 0.1s both; }

        /* Sidebar */
        .sidebar {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius-md);
            padding: 25px;
            box-shadow: var(--shadow-md);
            height: fit-content;
            animation: slideInUp 0.5s ease;
            transition: var(--transition-std);
        }
        .sidebar.hidden { display:none; } /* For hiding sidebar in detail views */

        .sidebar h3 { font-size: 1.1em; margin-bottom: 15px; color: var(--offwhite); padding-left: 15px; position: relative; }
        .sidebar h3::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 5px; height: 18px; background-color: var(--accent-color); border-radius: 3px; }
        .sort-section, .filter-section, .manage-section { margin-bottom: 30px; }
        #sort-select, .projects-filter select {
            width: 100%; padding: 12px 15px; border-radius: var(--border-radius-sm);
            background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); font-size: 14px; transition: var(--transition-std);
        }
        #sort-select:hover, #sort-select:focus,
        .projects-filter select:hover, .projects-filter select:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(var(--sapphire-rgb), 0.2);
        }
        .tag-filters, .manage-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .tag-filter {
            background-color: var(--input-bg-color); color: var(--light-text);
            padding: 7px 12px; border-radius: var(--border-radius-sm);
            font-size: 13px; border: 1px solid var(--border-color); transition: var(--transition-std);
        }
        .tag-filter:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); border-color: var(--accent-color); color: var(--offwhite); }
        .tag-filter.active { background-color: var(--accent-color); color: var(--offwhite); border-color: var(--accent-color); font-weight: 500; }
        .project-filter.status-active { border-left: 4px solid var(--active-color); padding-left: 8px; }
        .project-filter.status-waiting { border-left: 4px solid var(--waiting-color); padding-left: 8px; }
        .manage-item {
            background-color: var(--input-bg-color); padding: 8px 12px; border-radius: var(--border-radius-sm);
            font-size: 13px; display: flex; align-items: center; justify-content: space-between; width: 100%;
            border: 1px solid var(--border-color); transition: var(--transition-std);
        }
        .manage-item:hover { transform: translateX(4px); background-color: var(--secondary-color); border-color: var(--accent-color); }
        .manage-item-remove { background: none; border: none; color: var(--danger-color); font-size: 14px; opacity: 0.8; transition: var(--transition-fast); }
        .manage-item-remove:hover { opacity: 1; transform: scale(1.1); }

        .weekly-section { margin-bottom: 30px; }
        .weekly-dots-grid { display: grid; grid-template-columns: repeat(3, 12px); gap: 6px; }
        .weekly-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* Task Container & Action Toolbar */
        .task-container { display: flex; flex-direction: column; gap: 25px; animation: slideInUp 0.5s ease; }
        .action-buttons-toolbar {
            display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 15px;
            background-color: var(--secondary-color); border-radius: var(--border-radius-md); box-shadow: var(--shadow-md);
        }
        .action-btn { /* Shared by toolbar and other key actions */
            padding: 10px 18px; border-radius: var(--border-radius-sm); transition: var(--transition-std);
            font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; border: none; color: var(--offwhite);
        }
        .action-btn i { font-size: 1.1em; margin-right: 4px; }
        #add-task-btn { background-color: var(--accent-color); }
        #quick-add-btn { background-color: var(--success-color); color: var(--primary-color); }
        #new-project-btn { background-color: var(--lavender); color: var(--primary-color); }
        #new-concept-btn, #add-folder-btn { background-color: #d08770; } /* Nord orange */
        #clear-completed-btn { background-color: var(--danger-color); margin-left: auto; }
        #add-weekly-task-btn { background-color: var(--mint); color: var(--primary-color); }
        #backup-btn { background-color: var(--accent-color); }
        #restore-btn { background-color: var(--warning-color); color: var(--primary-color); }
        .action-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: var(--shadow-sm); filter: brightness(1.1); }
        .action-btn:active { transform: scale(0.98); }

        /* Quick Task / Concept Areas */
        .quick-task-area, .concept-area, .data-area, .weekly-area {
            background-color: var(--secondary-color); border-radius: var(--border-radius-md); padding: 20px;
            margin-bottom: 25px; box-shadow: var(--shadow-md); animation: slideInUp 0.5s ease;
        }
        .quick-task-header, .concept-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
        }
        .quick-task-header h3, .concept-header h3 { font-size: 1.3em; }
        .close-quick-task-btn, .close-concept-btn { background: none; border: none; color: var(--light-text); font-size: 18px; opacity: 0.7; transition: var(--transition-fast); }
        .close-quick-task-btn:hover, .close-concept-btn:hover { opacity: 1; transform: rotate(90deg) scale(1.1); }
        #quick-task-input, #concept-title-input, #concept-input {
            width: 100%; padding: 12px 16px; border-radius: var(--border-radius-sm); background-color: var(--input-bg-color);
            color: var(--text-color); border: 1px solid var(--border-color); font-size: 15px; transition: var(--transition-std);
        }
        #quick-task-input:focus, #concept-title-input:focus, #concept-input:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--sapphire-rgb), 0.2);
        }
        #concept-input { min-height: 120px; resize: vertical; margin-top: 10px; }
        .concept-input-container .action-btn-group { display: flex; gap: 10px; margin-top: 15px; }
        #save-concept-btn, #work-out-concept-btn { width: auto; background-color: var(--success-color); color: var(--primary-color); } /* Make them fit content */

        .quick-tasks-list, .concepts-list { display: flex; flex-direction: column; gap: 12px; }
        .quick-task-item, .concept-item {
            background-color: var(--primary-color); border-radius: var(--border-radius-sm); padding: 15px;
            border-left: 4px solid var(--accent-color); transition: var(--transition-std); animation: fadeIn 0.3s ease;
        }
        .quick-task-item { display: flex; justify-content: space-between; align-items: center; }
        .quick-task-item:hover, .concept-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-left-color: var(--mint); }
        .quick-task-text { font-size: 15px; }
        .quick-task-actions { display: flex; gap: 10px; }
        .quick-task-action-btn { background: none; border: none; color: var(--light-text); font-size: 16px; opacity: 0.8; transition: var(--transition-fast); padding: 5px; }
        .quick-task-action-btn:hover { opacity: 1; transform: scale(1.15); }
        .quick-task-action-btn.process-btn { color: var(--success-color); }
        .quick-task-action-btn.delete-btn { color: var(--danger-color); }
        .concept-item .concept-header { border-bottom: none; padding-bottom: 0; margin-bottom: 8px; display:flex; justify-content:space-between; align-items:center;}
        .concept-title { font-size: 1.1em; } .concept-date { font-size: 0.8em; opacity: 0.7; }
        .concept-preview { font-size: 0.9em; color: var(--light-text); opacity: 0.9; margin-bottom: 15px; max-height: 60px; overflow: hidden; text-overflow: ellipsis; }
        .concept-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .concept-action-btn { background-color: var(--secondary-color); width: 34px; height: 34px; border-radius: var(--border-radius-sm); display:inline-flex; align-items:center; justify-content:center;}
        .concept-action-btn:hover { filter: brightness(1.2); }

        /* Concept Detail & Project Detail (Shared Styles) */
        .concept-detail, .project-detail {
            background-color: var(--secondary-color); border-radius: var(--border-radius-md); padding: 25px;
            box-shadow: var(--shadow-lg); animation: expandIn 0.4s ease; 
            /* display: none; /* REMOVED - This was the issue, handled by .hidden class */
        }
        /* ADDED: Ensure elements are shown when .hidden is not present */
        .concept-detail:not(.hidden),
        .project-detail:not(.hidden) {
            display: flex; /* Or block, depending on desired layout */
            flex-direction: column; /* Assuming a column layout for these detail views */
        }

        .concept-detail-header, .project-detail-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
        }
        .back-btn { padding: 10px 15px; border-radius: var(--border-radius-sm); font-size: 14px; gap: 6px; background-color: var(--input-bg-color); }
        .back-btn:hover { background-color: var(--border-color); transform: translateX(-4px); }
        .concept-detail-actions, .project-detail-actions { display: flex; gap: 12px; }
        .edit-concept-btn, .delete-concept-btn, .concept-to-project-btn, /* from concept detail */
        .edit-project-btn, .delete-project-btn /* from project detail */ { 
            background-color: var(--input-bg-color); padding: 10px 15px; border-radius: var(--border-radius-sm);
            font-size: 14px; gap: 6px;
        }
        .edit-concept-btn:hover, .edit-project-btn:hover { background-color: var(--accent-color); }
        .delete-concept-btn:hover, .delete-project-btn:hover, .delete-folder-btn:hover { background-color: var(--danger-color); }
        .delete-folder-btn { background-color: red; color: var(--offwhite); }
        #rename-folder-btn { background-color: var(--accent-color); }
        .data-actions { display:flex; gap:10px; margin-bottom:15px; }
        .backup-info { font-size:0.9em; color:var(--light-text); }
        .concept-to-project-btn:hover { background-color: var(--success-color); color: var(--primary-color); }
        
        .concept-detail-title { font-size: 1.8em; } /* Specific for concept detail title */
        #project-detail-title { font-size: 1.8em; } /* Specific for project detail title */
        
        .concept-detail-date, .project-detail-dates { font-size: 0.85em; opacity: 0.7; margin-bottom: 20px; }
        .project-detail-dates { display: flex; gap: 20px; } .date-item { display: flex; align-items: center; gap: 5px; }
        #concept-detail-text { width: 100%; min-height: 250px; padding: 15px; border-radius: var(--border-radius-sm); background-color: var(--input-bg-color); line-height: 1.7; }
        #concept-detail-text:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--sapphire-rgb), 0.2); }
        .concept-detail-footer { margin-top: 25px; display: flex; justify-content: flex-end; }
        #save-concept-detail-btn { background-color: var(--success-color); color: var(--primary-color); padding: 10px 18px; border-radius: var(--border-radius-sm); font-size: 15px; font-weight: 500; gap: 8px; }
        
        .project-detail-main { display: flex; gap: 25px; margin-bottom: 30px; align-items: flex-start;}
        .project-detail-image {
            width: 100%; max-width: 300px; height: 200px; border-radius: var(--border-radius-sm);
            background-color: var(--input-bg-color); background-size: cover; background-position: center;
            display:flex; align-items:center; justify-content:center;
        }
        .project-detail-image .no-image-placeholder { font-size: 2.5em; color: var(--border-color); opacity: 0.4; }
        .project-detail-info { flex: 1; }
        .project-detail-status { margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .status-badge { padding: 5px 12px; border-radius: 15px; font-size: 0.85em; font-weight: 500; }
        .status-badge.status-active { background-color: var(--active-color); color: var(--primary-color); }
        .status-badge.status-waiting { background-color: var(--waiting-color); color: var(--primary-color); }
        .status-badge.status-completed { background-color: var(--completed-color); color: var(--primary-color); }
        .status-badge.status-storage { background-color: var(--storage-color); color: var(--offwhite); }

        
        .project-detail-tabs { display: flex; gap: 1px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; background-color: var(--input-bg-color); border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0; overflow:hidden;}
        .tab-btn {
            padding: 12px 20px; background: none; border: none; color: var(--light-text);
            font-size: 1em; transition: var(--transition-std); flex-grow: 1; text-align:center;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover { background-color: var(--secondary-color); color:var(--offwhite); }
        .tab-btn.active { background-color: var(--secondary-color); color: var(--offwhite); font-weight: 500; border-bottom-color: var(--accent-color); }
        .tab-content { margin-top: 0; padding: 20px; background-color: var(--secondary-color); border-radius: 0 0 var(--border-radius-sm) var(--border-radius-sm); animation: fadeIn 0.3s ease; }
        .overview-section { margin-bottom: 30px; }
        .overview-section h3 { font-size: 1.2em; margin-bottom: 12px; padding-left: 0; }
        .overview-section h3::before { display: none; } /* Remove sidebar-style accent */
        #project-description { font-size: 1em; line-height: 1.7; white-space: pre-wrap; color: var(--light-text); }
        
        .project-tasks-header, .project-notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .add-project-task-btn, .add-note-btn { /* Shared style for add buttons in tabs */
            background-color: var(--accent-color); color: var(--offwhite); padding: 9px 15px;
            border-radius: var(--border-radius-sm); font-size: 0.9em; gap: 6px;
        }
        #add-project-task-btn { background-color: var(--success-color); color: var(--primary-color); }
        #add-note-btn { background-color: var(--success-color); color: var(--primary-color); }
        .add-project-task-btn:hover, .add-note-btn:hover { filter: brightness(1.15); transform: translateY(-2px); }
        
        .project-tasks-list { display: flex; flex-direction: column; gap: 12px; }
        .project-task-item {
            background-color: var(--primary-color); border-radius: var(--border-radius-sm); padding: 15px;
            display: flex; gap: 12px; align-items: flex-start; transition: var(--transition-std);
            border-left: 4px solid transparent;
        }
        .project-task-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .project-task-item.status-active:not(.completed) { border-left-color: var(--active-color); }
        .project-task-item.status-waiting:not(.completed) { border-left-color: var(--waiting-color); }
        .project-task-item.completed { opacity: 0.6; border-left-color: var(--completed-color); }
        .project-task-item.completed .project-task-title { text-decoration: line-through; text-decoration-color: var(--light-text); }
        .project-task-checkbox input[type="checkbox"] { accent-color: var(--accent-color); width: 18px; height: 18px; margin-top:3px; }
        .project-task-content { flex: 1; } .project-task-title { font-size: 1em; font-weight: 500; margin-bottom: 6px; }
        .project-task-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.8em; color: var(--light-text); }
        .project-task-meta span { display:inline-flex; align-items:center; gap: 4px;}
        .project-task-meta .task-deadline.urgent { color: var(--danger-color); font-weight: bold; }
        .project-task-meta .task-waiting { color: var(--warning-color); }
        .project-task-actions .task-action-btn { width:32px; height:32px; background-color: var(--secondary-color); }
        .project-task-actions .task-action-btn:hover { background-color: var(--accent-color); }

        /* Projects View */
        .projects-area { margin-bottom: 25px; animation: slideInUp 0.5s ease; }
        .projects-header { padding-bottom: 15px; border-bottom: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;}
        .projects-header h3 { font-size: 1.6em; }
        .projects-view-toggle { gap: 8px; display:flex; }
        .view-toggle-btn { background-color: var(--input-bg-color); padding: 9px 14px; border-radius: var(--border-radius-sm); gap: 6px; }
        .view-toggle-btn.active { background-color: var(--accent-color); font-weight: 500; }
        .view-toggle-btn:hover:not(.active) { background-color: var(--border-color); }
        .folder-nav { display:flex; align-items:center; gap:10px; margin-top:10px; }
        .folder-nav.hidden { display:none; }
        .projects-filter { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items:center; margin-top:20px;}
        .projects-filter input[type="text"], .projects-filter select { flex: 1; min-width: 200px; padding: 12px 15px; background-color: var(--input-bg-color); border-radius: var(--border-radius-sm); border:1px solid var(--border-color); color: var(--text-color);}
        .projects-filter input[type="text"]:focus, .projects-filter select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(var(--sapphire-rgb), 0.2); }
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .project-card {
            background-color: var(--secondary-color); border-radius: var(--border-radius-md); overflow: hidden;
            box-shadow: var(--shadow-md); cursor: pointer; height: 100%; display: flex; flex-direction: column;
            animation: expandIn 0.4s ease; border-top: 4px solid transparent; /* For status indication */
            transition: var(--transition-std), border-top-color 0.3s ease;
        }
        .project-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
        .project-card.status-active { border-top-color: var(--active-color); }
        .project-card.status-waiting { border-top-color: var(--waiting-color); }
        .project-card.status-completed { border-top-color: var(--completed-color); opacity: 0.7; }
        .project-card.status-storage { border-top-color: var(--storage-color); opacity: 0.85; }
        .project-image { height: 160px; position: relative; background-color:var(--input-bg-color); background-size:cover; background-position:center; display:flex; align-items:center; justify-content:center;}
        .project-image .no-image-placeholder {font-size:3em; color:var(--border-color); opacity:0.5;}
        .project-status-badge { position: absolute; top: 12px; right: 12px; background-color: rgba(var(--charcoal-rgb, 32, 35, 42), 0.8); backdrop-filter: blur(3px); color: var(--offwhite); padding: 5px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 500; }
        .project-content { padding: 20px; display: flex; flex-direction: column; gap: 10px; flex: 1; }
        .project-title { font-size: 1.25em; margin-bottom: 5px;}
        .project-description { font-size: 0.9em; color: var(--light-text); opacity: 0.9; margin-bottom: 10px; flex-grow:1; max-height: 5em; overflow:hidden; }
        .project-meta { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.8em; margin-bottom:10px; }
        .project-meta-item { display: flex; align-items: center; gap: 5px; }
        .project-toggle-status { width:100%; justify-content:center; font-size:0.9em; padding:8px; margin-top:auto; background-color: var(--input-bg-color); }
        .project-toggle-status:hover { background-color: var(--border-color); }

        .projects-list { display: flex; flex-direction: column; gap: 15px; }
        .project-list-item {
            background-color: var(--secondary-color); border-radius: var(--border-radius-sm); padding: 15px 20px;
            display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center;
            box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition-std);
            border-left: 5px solid transparent;
        }
        .project-list-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .project-list-item.status-active { border-left-color: var(--active-color); }
        .project-list-item.status-waiting { border-left-color: var(--waiting-color); }
        .project-list-item.status-completed { border-left-color: var(--completed-color); opacity: 0.7; }
        .project-list-item.status-storage { border-left-color: var(--storage-color); opacity: 0.85; }
        .project-list-status { background-color: var(--input-bg-color); padding: 5px 10px; border-radius: 15px; font-size: 0.8em; white-space: nowrap; }
        .project-list-item.status-active .project-list-status { background-color: var(--active-color); color:var(--primary-color); }
        .project-list-item.status-waiting .project-list-status { background-color: var(--waiting-color); color:var(--primary-color); }
        .project-list-item.status-completed .project-list-status { background-color: var(--completed-color); color:var(--primary-color); }
        .project-list-item.status-storage .project-list-status { background-color: var(--storage-color); color:var(--offwhite); }
        .project-list-main { overflow: hidden; }
        .project-list-main .project-title {font-size: 1.1em;}
        .project-list-meta { display: flex; gap: 15px; font-size: 0.8em; margin-top:5px; color: var(--light-text); }
        .project-list-item .project-toggle-status {padding: 8px 12px; font-size:0.9em;}

        /* Notes Grid & Cards (in Project Detail) */
        .notes-sort-container { margin-left: auto; } /* Push sort to right */
        .notes-filter-container { margin-bottom: 15px; }
        .note-tag-filters { display: flex; flex-wrap: wrap; gap: 8px; }
        .note-tag-filter { background-color: var(--input-bg-color); padding: 5px 10px; border-radius:var(--border-radius-sm); font-size: 0.8em; }
        .note-tag-filter.active { background-color: var(--accent-color); color: var(--offwhite); }
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .note-card {
            background-color: var(--primary-color); border-radius: var(--border-radius-sm); padding: 18px;
            display: flex; flex-direction: column; transition: var(--transition-std); cursor: pointer;
            min-height: 160px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);
        }
        .note-card:hover { transform: translateY(-4px) scale(1.02); box-shadow: var(--shadow-md); border-color: var(--accent-color); }
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .note-title { font-size: 1.05em; font-weight: 500; }
        .note-date { font-size: 0.75em; opacity: 0.7; }
        .note-content-preview { font-size: 0.9em; opacity: 0.9; line-height: 1.5; flex-grow: 1; margin-bottom: 10px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
        .note-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: auto; }
        .note-tag { background-color: var(--secondary-color); padding: 3px 7px; border-radius: 4px; font-size: 0.7em; }

        /* Fullscreen Note Editor Overlay */
        #note-editor-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            z-index: 1050; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        #note-editor-overlay.visible { opacity: 1; visibility: visible; transition-delay: 0s; }
        .note-editor-container {
            background-color: var(--secondary-color); width: 90%; max-width: 750px;
            height: 80%; max-height: 650px; border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s ease 0.1s; overflow: hidden;
        }
        #note-editor-overlay.visible .note-editor-container { transform: scale(1); }
        .note-editor-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .note-editor-header h3 { font-size: 1.3em; }
        #close-note-editor-btn { background: none; border: none; font-size: 22px; color: var(--light-text); transition: var(--transition-fast); }
        #close-note-editor-btn:hover { color: var(--danger-color); transform: rotate(90deg); }
        #quill-editor-inner-container { flex-grow: 1; display: flex; flex-direction: column; background-color:var(--offwhite); } /* Added background to make quill visible */
        #quill-editor-inner-container .ql-toolbar { background-color: var(--input-bg-color); border:none; border-bottom: 1px solid var(--border-color); padding: 8px; }
        #quill-editor-inner-container .ql-toolbar .ql-stroke, #quill-editor-inner-container .ql-toolbar .ql-picker-label { color: var(--light-text) !important; stroke: var(--light-text) !important; }
        #quill-editor-inner-container .ql-toolbar .ql-fill { fill: var(--light-text) !important; }
        #quill-editor-inner-container .ql-container { border: none; font-size: 1em; flex-grow: 1; overflow-y:auto; }
        #quill-editor-inner-container .ql-editor {
            padding: 15px; line-height: 1.7; min-height:100%;
            color: var(--charcoal);
        }
        .note-editor-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; background-color: var(--input-bg-color);}
        #save-edited-note-btn, #edit-note-btn-overlay { padding: 9px 16px; border-radius: var(--border-radius-sm); font-size: 0.9em; font-weight: 500; }
        #save-edited-note-btn { background-color: var(--success-color); color: var(--primary-color); }
        /* #edit-note-btn-overlay (if used) */


        /* Main Tasks List */
        .tasks-list { display: flex; flex-direction: column; gap: 20px; }
        .weekly-tasks-list { display: flex; flex-direction: column; gap: 16px; }
        .weekly-task-card { background-color: var(--secondary-color); border-radius: var(--border-radius-md); padding: 15px; box-shadow: var(--shadow-md); border-left:5px solid transparent; }
        .weekly-task-card.status-not { border-left-color: var(--danger-color); }
        .weekly-task-card.status-planned { border-left-color: var(--accent-color); }
        .weekly-task-card.status-completed { border-left-color: var(--success-color); opacity:0.85; }
        .weekly-task-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:8px; }
        .weekly-progress-bar { height:8px; background-color: var(--border-color); border-radius:4px; overflow:hidden; }
        .weekly-progress-bar-inner { height:100%; background-color: var(--lavender); width:0%; }
        .weekly-input-row { display:flex; gap:8px; margin-top:8px; align-items:center; }
        .weekly-time-input { flex:1; padding:6px 10px; border-radius: var(--border-radius-sm); background-color: var(--input-bg-color); border:1px solid var(--border-color); color:var(--text-color); }
        .task-card {
            background-color: var(--secondary-color); border-radius: var(--border-radius-md); padding: 20px;
            box-shadow: var(--shadow-md); transition: box-shadow 0.3s ease, transform 0.3s ease;
            position: relative;
            border-left: 5px solid transparent; /* Default, status will override */
            animation: expandIn 0.3s ease;
        }
        .task-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .task-card.status-active:not(.completed) { border-left-color: var(--active-color); }
        .task-card.status-waiting:not(.completed) { border-left-color: var(--waiting-color); }
        .task-card.completed { opacity: 0.65; border-left-color: var(--completed-color) !important; }
        .task-card.completed .task-title { text-decoration: line-through; text-decoration-color: var(--light-text); }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .task-title { font-size: 1.2em; margin-right: 10px; word-break: break-word; }
        .task-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
        .task-action-btn {
            background-color: var(--primary-color); border: 1px solid var(--border-color);
            width: 38px; height: 38px; border-radius: 50%; display:inline-flex; align-items:center; justify-content:center;
        }
        .task-action-btn:hover { transform: scale(1.05) translateY(-1px); box-shadow: var(--shadow-sm); }
        .task-action-btn.task-complete-btn { background-color: var(--success-color); color: var(--primary-color); border-color:var(--success-color); }
        .task-action-btn.task-edit-btn:hover { background-color: var(--accent-color); border-color:var(--accent-color); }
        .task-action-btn.move-to-waiting-btn { background-color: var(--warning-color); color: var(--primary-color); border-color: var(--warning-color);}
        .task-action-btn.move-to-active-btn { background-color: var(--active-color); color: var(--primary-color); border-color: var(--active-color);}
        .task-description { font-size: 0.9em; color: var(--light-text); margin-bottom: 12px; line-height: 1.5; }
        .task-meta { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 12px; font-size: 0.85em; }
        .task-meta-item { display: flex; align-items: center; gap: 5px; }
        .task-meta-item i { font-size: 1em; opacity: 0.8; }
        .task-deadline.urgent { color: var(--danger-color); font-weight: bold; }
        .task-deadline.near-deadline { color: var(--warning-color); }
        .task-project { font-size: 0.9em; background-color: var(--input-bg-color); padding: 5px 10px; border-radius: var(--border-radius-sm); margin-bottom: 10px; display: inline-block; border:1px solid var(--border-color); }
        .task-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .task-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; background-color: var(--input-bg-color); border:1px solid var(--border-color); }
        .task-priority { position: absolute; top: 15px; right: 15px; background-color: var(--input-bg-color); padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 500; border:1px solid var(--border-color); }
        .task-priority.priority-val-1 { border-color: var(--lavender); color:var(--lavender); } /* Medium */
        .task-priority.priority-val-2, .task-priority.priority-val-3 { border-color: var(--warning-color); color: var(--warning-color); } /* High */
        .task-priority.priority-val-4, .task-priority.priority-val-5, .task-priority.priority-val-6 { border-color: var(--danger-color); color: var(--danger-color); } /* Urgent */

        
        /* Modals (General) */
        .modal {
            display: none; /* Initially hidden */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(var(--charcoal-rgb, 32, 35, 42), 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000; overflow-y: auto;
            align-items: center; justify-content: center; /* For centering content */
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s;
        }
        .modal.visible { display: flex; opacity: 1; visibility: visible; transition-delay: 0s; }
        .modal-content {
            background-color: var(--secondary-color);
            width: 90%; max-width: 600px;
            border-radius: var(--border-radius-md); box-shadow: var(--shadow-lg);
            max-height: 90vh; display: flex; flex-direction: column;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.3s ease 0.05s, opacity 0.3s ease 0.05s; /* Slight delay for transform */
        }
        .modal.visible .modal-content { transform: scale(1); opacity: 1; animation: expandIn 0.3s ease; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.4em; }
        .close-modal { font-size: 24px; color: var(--light-text); transition: var(--transition-fast); background:none; border:none; cursor:pointer; }
        .close-modal:hover { color: var(--danger-color); transform: rotate(90deg); }
        .modal-body { padding: 25px; overflow-y: auto; }
        
        /* Form Elements within Modals */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.95em; font-weight: 500; color: var(--light-text); }
        .form-group input[type="text"], .form-group input[type="date"], .form-group input[type="time"],
        .form-group select, .form-group textarea {
            width: 100%; padding: 12px 15px; border-radius: var(--border-radius-sm);
            background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); font-size: 1em; transition: var(--transition-std);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(var(--sapphire-rgb), 0.2);
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .deadline-container { display: flex; gap: 10px; align-items: center; } /* Time toggle removed */
        .importance-options, .status-options { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-container { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .radio-container input[type="radio"] { accent-color: var(--accent-color); width:16px; height:16px; }
        .radio-label { font-size: 0.95em; }
        .suggested-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .suggested-tag { background-color: var(--input-bg-color); padding: 5px 10px; border-radius: 4px; font-size: 0.8em; border:1px solid var(--border-color); }
        .suggested-tag:hover { background-color: var(--accent-color); color:var(--offwhite); border-color:var(--accent-color); }
        .form-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
        .submit-btn, .cancel-btn, .delete-btn { padding: 10px 18px; border-radius: var(--border-radius-sm); font-size: 0.95em; font-weight: 500; transition: var(--transition-std); }
        .submit-btn { background-color: var(--accent-color); color: var(--offwhite); }
        .submit-btn:hover { filter:brightness(1.15); transform:translateY(-2px); }
        .cancel-btn { background-color: var(--input-bg-color); color: var(--light-text); border: 1px solid var(--border-color); }
        .cancel-btn:hover { background-color: var(--border-color); }
        .delete-btn { background-color: var(--danger-color); color: var(--offwhite); margin-right: auto; } /* Push to left */
        .delete-btn:hover { filter:brightness(1.15); transform:translateY(-2px); }
        .image-upload-container { display: flex; flex-direction: column; gap: 10px; }
        .image-upload-label { display: inline-flex; align-items:center; gap:8px; background-color: var(--input-bg-color); color: var(--light-text); padding: 9px 14px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); width: fit-content; }
        .image-upload-label:hover { background-color: var(--border-color); }
        .image-upload-input { display: none; }
        .image-preview { width: 100%; height: 150px; background-color: var(--input-bg-color); border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px dashed var(--border-color); }
        .image-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-preview:empty::before { content:"Image Preview"; color:var(--light-text); opacity:0.5;}

        /* Hidden Helper */
        .hidden { display: none !important; }
        .hidden-by-default { display: none; } /* For form sections */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--light-text); opacity: 0.7; }
        .empty-state i { font-size: 3em; margin-bottom: 15px; display: block; }


        /* Toast Messages */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display:flex; flex-direction:column; gap:10px; }
        .toast {
            min-width: 280px; max-width: 400px; background-color: var(--secondary-color); color: var(--text-color);
            padding: 15px 20px; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-lg);
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateX(100%); transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-left: 5px solid var(--accent-color); /* Default info */
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-icon { font-size: 1.3em; }
        .toast-message { flex-grow: 1; font-size: 0.95em; }
        .toast-close { background: none; border: none; color: var(--light-text); font-size: 1.1em; opacity: 0.7; margin-left: auto; padding: 0 5px;}
        .toast-close:hover { opacity: 1; }
        .toast.toast-success { border-left-color: var(--success-color); } .toast.toast-success .toast-icon { color: var(--success-color); }
        .toast.toast-error { border-left-color: var(--danger-color); } .toast.toast-error .toast-icon { color: var(--danger-color); }
        .toast.toast-warning { border-left-color: var(--warning-color); } .toast.toast-warning .toast-icon { color: var(--warning-color); }

        /* Responsive */
        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
            .sidebar { order: 1; margin-top:20px; }
            .main-content.sidebar-hidden .task-container { grid-column: 1 / -1; } /* Ensure full width when sidebar is programmatically hidden */

        }
        @media (max-width: 768px) {
            body { font-size:14px; }
            .app-container { padding:15px; }
            header { flex-direction: column; align-items: stretch; gap: 15px; margin-bottom:25px; }
            .view-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
            .action-buttons-toolbar { flex-direction: column; } .action-buttons-toolbar .action-btn { width: 100%; justify-content: center; }
            #clear-completed-btn { margin-left: 0; }
            .projects-filter { flex-direction: column; }
            .modal-content { width: 95%; max-height: 85vh; }
            .project-detail-main { flex-direction:column; } .project-detail-image {max-width:none;}
            .project-detail-tabs { font-size:0.9em; } .tab-btn {padding:10px 15px;}
        }

        /* Folder Cards */
        .folder-card {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition-std);
        }
        .folder-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .folder-icon { font-size: 2.2em; }
        .folder-card .folder-name { font-weight: 500; }

        .folder-list-item {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius-sm);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition-std);
        }
        .folder-list-item:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .folder-list-item .folder-icon { font-size: 1.6em; }
        #menu-pin-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--offwhite);
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background 0.2s;
        }
        #menu-pin-btn:hover { background-color: var(--accent-color); }

    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="logo-wrapper"><span class="logo-text">Task Manager</span></div>
            <div class="view-controls">
                <button id="active-view-btn" class="view-btn active">Active Tasks</button>
                <button id="waiting-view-btn" class="view-btn">Waiting Tasks</button>
                <button id="completed-view-btn" class="view-btn">Completed Tasks</button>
                <button id="weekly-view-btn" class="view-btn">Weekly Tasks</button>
                <button id="quick-tasks-view-btn" class="view-btn">Quick Tasks</button>
                <button id="projects-view-btn" class="view-btn">Projects</button>
                <button id="concepts-view-btn" class="view-btn">Concepts</button>
                <button id="data-view-btn" class="view-btn">Data</button>
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="sort-section">
                    <h3>Sort Tasks By</h3>
                    <select id="sort-select">
                        <option value="priority">Priority</option>
                        <option value="deadline">Deadline</option>
                        <option value="importance">Importance</option>
                        <option value="created">Date Created</option>
                    </select>
                </div>
                <div class="filter-section">
                    <h3>Filter Tasks By Tags</h3>
                    <div id="tag-filters" class="tag-filters">
                        <!-- Tag filters will be dynamically populated here -->
                         <div class="empty-state hidden"><p>No tags yet.</p></div>
                    </div>
                </div>
                <div class="filter-section" id="project-filter-section">
                    <h3>Filter Tasks By Projects</h3>
                    <div id="project-filters" class="project-filters tag-filters">
                        <!-- Project filters will be dynamically populated here -->
                         <div class="empty-state hidden"><p>No active projects.</p></div>
                    </div>
                </div>
                <div class="weekly-section">
                    <h3>Weekly Tasks</h3>
                    <div id="weekly-dots-grid" class="weekly-dots-grid">
                        <div class="empty-state hidden"><p>No weekly tasks.</p></div>
                    </div>
                </div>
                <div class="manage-section">
                    <h3>Manage Tags</h3>
                    <div id="manage-tags" class="manage-tags">
                        <!-- Managed tags will be dynamically populated here -->
                        <div class="empty-state hidden"><p>No tags to manage.</p></div>
                    </div>
                </div>
            </div>

            <div class="task-container"> 
                <div class="action-buttons-toolbar">
                    <button id="add-task-btn" class="action-btn"><i class="fas fa-plus"></i> Add Task</button>
                    <button id="quick-add-btn" class="action-btn"><i class="fas fa-bolt"></i> Quick Add</button>
                    <button id="new-project-btn" class="action-btn"><i class="fas fa-folder-plus"></i> New Project</button>
                    <button id="new-concept-btn" class="action-btn"><i class="fas fa-lightbulb"></i> New Concept</button>
                    <button id="clear-completed-btn" class="action-btn"><i class="fas fa-trash-alt"></i> Clear Completed</button>
                </div>
                
                <div id="quick-task-area" class="quick-task-area hidden">
                    <div class="quick-task-header"><h3>Quick Task Entry</h3><button id="close-quick-task-btn" class="close-modal"><i class="fas fa-times"></i></button></div>
                    <div class="quick-task-input-container"><input type="text" id="quick-task-input" placeholder="Type task and press Enter..."></div>
                    <div id="quick-tasks-list" class="quick-tasks-list">
                        <!-- Quick tasks will be dynamically populated here -->
                    </div>
                </div>

                <div id="concept-area" class="concept-area hidden">
                    <div class="concept-header"><h3>Concept Development</h3><button id="close-concept-btn" class="close-modal"><i class="fas fa-times"></i></button></div>
                    <div class="concept-input-container">
                        <input type="text" id="concept-title-input" placeholder="Concept title...">
                        <textarea id="concept-input" placeholder="Jot down your concept ideas here..."></textarea>
                        <div class="action-btn-group">
                            <button id="save-concept-btn" class="action-btn"><i class="fas fa-save"></i> Save Concept</button>
                            <button id="work-out-concept-btn" class="action-btn"><i class="fas fa-brain"></i> Work Out</button>
                        </div>
                    </div>
                    <div id="concepts-list" class="concepts-list">
                        <!-- Concepts will be dynamically populated here -->
                    </div>
                </div>

                <div id="projects-area" class="projects-area hidden">
                    <div class="projects-header"><h3>Projects</h3><div class="projects-view-toggle">
                        <button id="grid-view-btn" class="view-toggle-btn action-btn active"><i class="fas fa-th-large"></i> Grid</button>
                        <button id="list-view-btn" class="view-toggle-btn action-btn"><i class="fas fa-list"></i> List</button>
                        <button id="add-folder-btn" class="action-btn"><i class="fas fa-folder-plus"></i> Add Folder</button>
                    </div></div>
                    <div id="folder-nav" class="folder-nav hidden"><button id="back-folder-btn" class="back-btn action-btn"><i class="fas fa-arrow-left"></i> Back</button><span id="current-folder-name"></span><button id="rename-folder-btn" class="action-btn"><i class="fas fa-edit"></i> Rename</button><button id="delete-folder-btn" class="action-btn delete-folder-btn"><i class="fas fa-trash"></i> Delete Folder</button></div>
                    <div class="projects-filter">
                        <input type="text" id="project-search" placeholder="Search projects...">
                        <select id="project-status-filter">
                            <option value="all">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="waiting">Waiting</option>
                            <option value="storage">Storage</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div id="projects-grid" class="projects-grid">
                        <!-- Project cards will be dynamically populated here -->
                    </div>
                    <div id="projects-list" class="projects-list hidden">
                        <!-- Project list items will be dynamically populated here -->
                    </div>
                </div>

                <div id="project-detail" class="project-detail hidden">
                    <div class="project-detail-header">
                        <button id="back-to-projects-btn" class="back-btn action-btn"><i class="fas fa-arrow-left"></i> Projects</button>
                        <div class="project-detail-actions">
                            <button id="edit-project-btn" class="edit-project-btn action-btn"><i class="fas fa-edit"></i> Edit</button>
                            <button id="delete-project-btn" class="delete-project-btn action-btn"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                    <div class="project-detail-content">
                        <div class="project-detail-main">
                            <div class="project-detail-image" aria-label="Project image"><div class="no-image-placeholder" aria-hidden="true"><i class="fas fa-image"></i></div></div>
                            <div class="project-detail-info">
                                <h2 id="project-detail-title"></h2>
                                <div id="project-detail-status"></div>
                                <div id="project-detail-dates"></div>
                            </div>
                        </div>
                        <div class="project-detail-tabs">
                            <button id="overview-tab" class="tab-btn active">Overview</button>
                            <button id="tasks-tab" class="tab-btn">Tasks</button>
                            <button id="notes-tab" class="tab-btn">Notes</button>
                        </div>
                        <div id="overview-content" class="tab-content"><div class="overview-section"><h3>Project Description</h3><p id="project-description"></p></div></div>
                        <div id="tasks-content" class="tab-content hidden">
                            <div class="project-tasks-header"><h3>Project Tasks</h3><button id="add-project-task-btn" class="action-btn"><i class="fas fa-plus"></i> Add Task</button></div>
                            <div id="project-tasks-list" class="project-tasks-list"></div>
                        </div>
                        <div id="notes-content" class="tab-content hidden">
                            <div class="project-notes-header"><h3>Project Notes</h3><div class="notes-sort-container"><select id="notes-sort-select"><option value="date">Date</option><option value="title">Title</option></select></div><button id="add-note-btn" class="action-btn"><i class="fas fa-plus"></i> Add Note</button></div>
                            <div class="notes-filter-container"><div id="note-tag-filters" class="tag-filters note-tag-filters"></div></div>
                            <div id="notes-grid" class="notes-grid"></div>
                        </div>
                    </div>
                </div>

                <div id="concept-detail" class="concept-detail hidden">
                    <div class="concept-detail-header">
                        <button id="back-to-concepts-btn" class="back-btn action-btn"><i class="fas fa-arrow-left"></i> Concepts</button>
                        <div class="concept-detail-actions">
                            <button id="delete-concept-btn" class="action-btn delete-concept-btn"><i class="fas fa-trash"></i> Delete</button>
                            <button id="concept-to-project-btn" class="action-btn concept-to-project-btn"><i class="fas fa-share-square"></i> To Project</button>
                        </div>
                    </div>
                    <div class="concept-detail-content">
                        <h2 id="concept-detail-title" contenteditable="true" spellcheck="false"></h2>
                        <div id="concept-detail-date"></div>
                        <div class="concept-detail-body"><textarea id="concept-detail-text" placeholder="Develop your concept here..."></textarea></div>
                        <div class="concept-detail-footer"><button id="save-concept-detail-btn" class="action-btn submit-btn"><i class="fas fa-save"></i> Save Concept</button></div>
                    </div>
                </div>

                <div id="tasks-list" class="tasks-list">
                    <!-- Tasks will be dynamically populated here -->
                </div>
                <div id="weekly-area" class="weekly-area hidden">
                    <div class="weekly-header"><h3>Weekly Tasks
                        <button id="add-weekly-task-btn" class="action-btn"><i class="fas fa-plus"></i></button>
                        <button id="weekly-history-btn" class="action-btn"><i class="fas fa-calendar-alt"></i></button>
                    </h3></div>
                    <div id="weekly-tasks-list" class="weekly-tasks-list"></div>
                </div>
                <div id="data-area" class="data-area hidden">
                    <h3>Data Management</h3>
                    <div class="data-actions">
                        <button id="backup-btn" class="action-btn"><i class="fas fa-download"></i> Backup Data</button>
                        <button id="restore-btn" class="action-btn"><i class="fas fa-upload"></i> Restore Backup</button>
                        <input type="file" id="restore-input" accept="application/json" style="display:none">
                    </div>
                    <div id="last-backup-info" class="backup-info"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-task-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Add New Task</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="task-form">
            <div class="form-group"><label for="task-title">Task Title</label><input type="text" id="task-title" placeholder="What needs to be done?" required></div>
            <div class="form-group"><label for="task-description">Description (Optional)</label><textarea id="task-description" placeholder="Add more details..."></textarea></div>
            <div class="form-group"><label for="task-project">Project (Optional)</label><select id="task-project"><option value="">-- None --</option></select></div>
            <div class="form-group"><label for="task-tags">Tags (Comma separated)</label><input type="text" id="task-tags" placeholder="e.g. work, personal"><div id="suggested-tags" class="suggested-tags"></div></div>
            <div class="form-group"><label for="task-deadline-date">Deadline</label><div class="deadline-container"><input type="date" id="task-deadline-date"></div></div>
            <div class="form-group"><label>Importance</label><div class="importance-options">
                <label class="radio-container"><input type="radio" name="importance" value="normal" checked><span class="radio-label">Normal</span></label>
                <label class="radio-container"><input type="radio" name="importance" value="high"><span class="radio-label">High</span></label>
                <label class="radio-container"><input type="radio" name="importance" value="super"><span class="radio-label">Super</span></label>
            </div></div>
            <div class="form-group"><label>Status</label><div class="status-options">
                <label class="radio-container"><input type="radio" name="status" value="active" checked><span class="radio-label">Active</span></label>
                <label class="radio-container"><input type="radio" name="status" value="waiting"><span class="radio-label">Waiting</span></label>
            </div></div>
            <div class="form-actions"><button type="button" id="cancel-task-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Add Task</button></div>
        </form></div>
    </div></div>
    <div id="edit-task-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Edit Task</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="edit-task-form">
            <input type="hidden" id="edit-task-id">
            <div class="form-group"><label for="edit-task-title">Task Title</label><input type="text" id="edit-task-title" required></div>
            <div class="form-group"><label for="edit-task-description">Description</label><textarea id="edit-task-description"></textarea></div>
            <div class="form-group"><label for="edit-task-project">Project</label><select id="edit-task-project"><option value="">-- None --</option></select></div>
            <div class="form-group"><label for="edit-task-tags">Tags</label><input type="text" id="edit-task-tags"><div id="edit-suggested-tags" class="suggested-tags"></div></div>
            <div class="form-group"><label for="edit-task-deadline-date">Deadline</label><div class="deadline-container"><input type="date" id="edit-task-deadline-date"></div></div>
            <div class="form-group"><label>Importance</label><div class="importance-options">
                <label class="radio-container"><input type="radio" name="edit-importance" value="normal"><span class="radio-label">Normal</span></label>
                <label class="radio-container"><input type="radio" name="edit-importance" value="high"><span class="radio-label">High</span></label>
                <label class="radio-container"><input type="radio" name="edit-importance" value="super"><span class="radio-label">Super</span></label>
            </div></div>
            <div class="form-group"><label>Status</label><div class="status-options">
                <label class="radio-container"><input type="radio" name="edit-status" value="active"><span class="radio-label">Active</span></label>
                <label class="radio-container"><input type="radio" name="edit-status" value="waiting"><span class="radio-label">Waiting</span></label>
            </div></div>
            <div class="form-actions"><button type="button" id="delete-task-btn" class="delete-btn">Delete Task</button><button type="button" id="cancel-edit-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Save Changes</button></div>
        </form></div>
    </div></div>
    <div id="add-project-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Add New Project</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="project-form">
            <div class="form-group"><label for="project-title">Project Title</label><input type="text" id="project-title" required></div>
            <div class="form-group"><label for="project-description-input">Description</label><textarea id="project-description-input"></textarea></div> <!-- Changed ID to avoid conflict -->
            <div class="form-group"><label>Project Image</label><div class="image-upload-container"><label for="project-image-upload" class="image-upload-label"><i class="fas fa-image"></i> Choose Image</label><input type="file" id="project-image-upload" class="image-upload-input" accept="image/*"><div id="image-preview" class="image-preview"></div></div></div>
            <div class="form-group"><label for="project-deadline-date">Deadline</label><input type="date" id="project-deadline-date"></div>
            <div class="form-group"><label>Status</label><div class="status-options">
                <label class="radio-container"><input type="radio" name="project-status" value="active" checked><span class="radio-label">Active</span></label>
                <label class="radio-container"><input type="radio" name="project-status" value="waiting"><span class="radio-label">Waiting</span></label>
                <label class="radio-container"><input type="radio" name="project-status" value="storage"><span class="radio-label">Storage</span></label>
                <label class="radio-container"><input type="radio" name="project-status" value="completed"><span class="radio-label">Completed</span></label>
            </div></div>
            <div class="form-actions"><button type="button" id="cancel-project-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Add Project</button></div>
        </form></div>
    </div></div>
    <div id="edit-project-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Edit Project</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="edit-project-form">
            <input type="hidden" id="edit-project-id">
            <div class="form-group"><label for="edit-project-title">Project Title</label><input type="text" id="edit-project-title" required></div>
            <div class="form-group"><label for="edit-project-description-input">Description</label><textarea id="edit-project-description-input"></textarea></div> <!-- Changed ID -->
            <div class="form-group"><label>Project Image</label><div class="image-upload-container"><label for="edit-project-image-upload" class="image-upload-label"><i class="fas fa-image"></i> Choose Image</label><input type="file" id="edit-project-image-upload" class="image-upload-input" accept="image/*"><div id="edit-image-preview" class="image-preview"></div></div></div>
            <div class="form-group"><label for="edit-project-deadline-date">Deadline</label><input type="date" id="edit-project-deadline-date"></div>
            <div class="form-group"><label>Status</label><div class="status-options">
                <label class="radio-container"><input type="radio" name="edit-project-status" value="active"><span class="radio-label">Active</span></label>
                <label class="radio-container"><input type="radio" name="edit-project-status" value="waiting"><span class="radio-label">Waiting</span></label>
                <label class="radio-container"><input type="radio" name="edit-project-status" value="storage"><span class="radio-label">Storage</span></label>
                <label class="radio-container"><input type="radio" name="edit-project-status" value="completed"><span class="radio-label">Completed</span></label>
            </div></div>
            <div class="form-actions"><button type="button" id="delete-project-btn-modal" class="delete-btn">Delete Project</button><button type="button" id="cancel-edit-project-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Save Changes</button></div>
        </form></div>
    </div></div>
    <div id="add-note-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Add New Note</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="note-form">
            <input type="hidden" id="note-project-id">
            <div class="form-group"><label for="note-title">Note Title</label><input type="text" id="note-title" placeholder="Title for your note" required></div>
            <div class="form-group"><label for="note-content">Content</label><textarea id="note-content" class="note-textarea" placeholder="Start writing your note..."></textarea></div>
            <div class="form-group"><label for="note-tags">Tags (Comma separated)</label><input type="text" id="note-tags" placeholder="e.g. meeting, idea"></div>
            <div class="form-actions"><button type="button" id="cancel-note-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Add Note</button></div>
        </form></div>
    </div></div>

    <div id="add-weekly-task-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Add Weekly Task</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="weekly-task-form">
            <div class="form-group"><label for="weekly-task-title">Title</label><input type="text" id="weekly-task-title" required></div>
            <div class="form-group"><label for="weekly-task-minutes">Target Minutes</label><input type="number" id="weekly-task-minutes" required></div>
            <div class="form-actions"><button type="button" id="cancel-weekly-task-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Add Weekly Task</button></div>
        </form></div>
    </div></div>
    <div id="edit-weekly-task-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h2>Edit Weekly Task</h2><span class="close-modal">&times;</span></div>
        <div class="modal-body"><form id="edit-weekly-task-form">
            <input type="hidden" id="edit-weekly-id">
            <div class="form-group"><label for="edit-weekly-task-title">Title</label><input type="text" id="edit-weekly-task-title" required></div>
            <div class="form-group"><label for="edit-weekly-task-minutes">Target Minutes</label><input type="number" id="edit-weekly-task-minutes" required></div>
            <div class="form-actions"><button type="button" id="delete-weekly-task-btn" class="delete-btn">Delete</button><button type="button" id="cancel-edit-weekly-btn" class="cancel-btn">Cancel</button><button type="submit" class="submit-btn">Save Changes</button></div>
        </form></div>
    </div></div>
    
    <div id="note-editor-overlay" class="modal"> 
        <div class="note-editor-container"> 
            <div class="note-editor-header">
                <h3 id="note-editor-title">Edit Note</h3>
                <button id="close-note-editor-btn" class="close-modal">&times;</button>
            </div>
            <div id="quill-editor-inner-container"></div> 
            <div class="note-editor-footer">
                 <button id="delete-current-note-btn" class="delete-btn" style="margin-right: auto;"><i class="fas fa-trash"></i> Delete Note</button>
                <button id="save-edited-note-btn" class="submit-btn"><i class="fas fa-save"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
    (function() {
        'use strict';

        // Global variables
        let tasks = [];
        let quickTasks = [];
        let tags = []; 
        let projects = [];
        let concepts = [];
        let notes = [];
        let folders = [];
        let weeklyTasks = [];
        let weeklyLogs = [];
        let currentFolderId = null;
        
        let currentView = 'active';
        let currentSort = 'priority';
        let activeFilters = []; 
        let noteActiveFilters = []; 
        let projectFilters = []; 
        let currentProjectId = null;
        let currentConceptId = null;
        let currentEditingNoteId = null; 
        let projectsViewMode = 'grid';
        let notesSort = 'date';
        let lastBackup = null;

        let db;
        const STORES = {
            TASKS: 'tasks', QUICK_TASKS: 'quickTasks', TAGS: 'tags',
            PROJECTS: 'projects', CONCEPTS: 'concepts', NOTES: 'notes',
            SETTINGS: 'settings', FOLDERS: 'folders',
            WEEKLY_TASKS: 'weeklyTasks', WEEKLY_LOGS: 'weeklyLogs'
        };

        window.finaDB = null;
        let quillEditor;

        const  = {
            appContainer: document.querySelector('.app-container'),
            mainContent: document.querySelector('.main-content'),
            sidebar: document.querySelector('.sidebar'),
            activeViewBtn: document.getElementById('active-view-btn'),
            waitingViewBtn: document.getElementById('waiting-view-btn'),
           completedViewBtn: document.getElementById('completed-view-btn'),
            weeklyViewBtn: document.getElementById('weekly-view-btn'),
            quickTasksViewBtn: document.getElementById('quick-tasks-view-btn'),
            projectsViewBtn: document.getElementById('projects-view-btn'),
            conceptsViewBtn: document.getElementById('concepts-view-btn'),
            dataViewBtn: document.getElementById('data-view-btn'),
            sortSelect: document.getElementById('sort-select'),
            tagFiltersContainer: document.getElementById('tag-filters'),
            projectFiltersContainer: document.getElementById('project-filters'),
            manageTagsContainer: document.getElementById('manage-tags'),
            addTaskBtn: document.getElementById('add-task-btn'),
            quickAddBtn: document.getElementById('quick-add-btn'),
            newProjectBtn: document.getElementById('new-project-btn'),
            addFolderBtn: document.getElementById('add-folder-btn'),
            folderNav: document.getElementById('folder-nav'),
            backFolderBtn: document.getElementById('back-folder-btn'),
            renameFolderBtn: document.getElementById('rename-folder-btn'),
            deleteFolderBtn: document.getElementById('delete-folder-btn'),
            currentFolderName: document.getElementById('current-folder-name'),
            newConceptBtn: document.getElementById('new-concept-btn'),
           clearCompletedBtn: document.getElementById('clear-completed-btn'),
           tasksList: document.getElementById('tasks-list'),
            weeklyArea: document.getElementById('weekly-area'),
            addWeeklyTaskBtn: document.getElementById('add-weekly-task-btn'),
            weeklyHistoryBtn: document.getElementById('weekly-history-btn'),
            weeklyTasksList: document.getElementById('weekly-tasks-list'),
            quickTaskArea: document.getElementById('quick-task-area'),
            closeQuickTaskBtn: document.getElementById('close-quick-task-btn'),
            quickTaskInput: document.getElementById('quick-task-input'),
            quickTasksList: document.getElementById('quick-tasks-list'),
            conceptArea: document.getElementById('concept-area'),
            closeConceptBtn: document.getElementById('close-concept-btn'),
            conceptTitleInput: document.getElementById('concept-title-input'),
            conceptInput: document.getElementById('concept-input'),
            saveConceptBtn: document.getElementById('save-concept-btn'),
            workOutConceptBtn: document.getElementById('work-out-concept-btn'),
            conceptsList: document.getElementById('concepts-list'),
            conceptDetailView: document.getElementById('concept-detail'),
            backToConceptsBtn: document.getElementById('back-to-concepts-btn'),
            deleteConceptBtn: document.getElementById('delete-concept-btn'), 
            conceptToProjectBtn: document.getElementById('concept-to-project-btn'),
            conceptDetailTitle: document.getElementById('concept-detail-title'),
            conceptDetailDate: document.getElementById('concept-detail-date'),
            conceptDetailText: document.getElementById('concept-detail-text'),
            saveConceptDetailBtn: document.getElementById('save-concept-detail-btn'),
            projectsArea: document.getElementById('projects-area'),
            gridViewBtn: document.getElementById('grid-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            projectSearchInput: document.getElementById('project-search'),
            projectStatusFilter: document.getElementById('project-status-filter'),
            projectsGrid: document.getElementById('projects-grid'),
            projectsListContainer: document.getElementById('projects-list'),
            projectDetailView: document.getElementById('project-detail'),
            backToProjectsBtn: document.getElementById('back-to-projects-btn'),
            editProjectDetailBtn: document.getElementById('edit-project-btn'), 
            deleteProjectDetailBtn: document.getElementById('delete-project-btn'), 
            projectDetailTitle: document.getElementById('project-detail-title'),
            projectDetailImage: document.querySelector('#project-detail .project-detail-image'),
            projectDetailStatus: document.getElementById('project-detail-status'),
            projectDetailDates: document.getElementById('project-detail-dates'),
            projectDetailDescription: document.getElementById('project-description'),
            overviewTab: document.getElementById('overview-tab'),
            tasksTab: document.getElementById('tasks-tab'),
            notesTab: document.getElementById('notes-tab'),
            overviewContent: document.getElementById('overview-content'),
            tasksContent: document.getElementById('tasks-content'),
            notesContent: document.getElementById('notes-content'),
            addProjectTaskBtn: document.getElementById('add-project-task-btn'),
            projectTasksList: document.getElementById('project-tasks-list'),
            addNoteBtn: document.getElementById('add-note-btn'),
            notesSortSelect: document.getElementById('notes-sort-select'),
            noteTagFiltersContainer: document.getElementById('note-tag-filters'),
            notesGrid: document.getElementById('notes-grid'),
            addTaskModal: document.getElementById('add-task-modal'),
            editTaskModal: document.getElementById('edit-task-modal'),
            addProjectModal: document.getElementById('add-project-modal'),
            editProjectModal: document.getElementById('edit-project-modal'),
            addNoteModal: document.getElementById('add-note-modal'),
            taskForm: document.getElementById('task-form'),
            taskTitleInput: document.getElementById('task-title'),
            taskDescriptionInput: document.getElementById('task-description'),
            taskProjectSelect: document.getElementById('task-project'),
            taskTagsInput: document.getElementById('task-tags'),
            suggestedTagsContainer: document.getElementById('suggested-tags'),
            taskDeadlineDateInput: document.getElementById('task-deadline-date'),
            cancelTaskBtn: document.getElementById('cancel-task-btn'),
            editTaskForm: document.getElementById('edit-task-form'),
            editTaskIdInput: document.getElementById('edit-task-id'),
            editTaskTitleInput: document.getElementById('edit-task-title'),
            editTaskDescriptionInput: document.getElementById('edit-task-description'),
            editTaskProjectSelect: document.getElementById('edit-task-project'),
            editTaskTagsInput: document.getElementById('edit-task-tags'),
            editSuggestedTagsContainer: document.getElementById('edit-suggested-tags'),
            editTaskDeadlineDateInput: document.getElementById('edit-task-deadline-date'),
            deleteTaskBtn: document.getElementById('delete-task-btn'), 
            cancelEditTaskBtn: document.getElementById('cancel-edit-btn'),
            projectForm: document.getElementById('project-form'),
            projectTitleInput: document.getElementById('project-title'),
            projectDescriptionInput: document.getElementById('project-description-input'), 
            projectImageUploadInput: document.getElementById('project-image-upload'),
            projectImagePreview: document.getElementById('image-preview'),
            projectDeadlineDateInput: document.getElementById('project-deadline-date'),
            cancelProjectBtn: document.getElementById('cancel-project-btn'),
            editProjectForm: document.getElementById('edit-project-form'),
            editProjectIdInput: document.getElementById('edit-project-id'),
            editProjectTitleInput: document.getElementById('edit-project-title'),
            editProjectDescriptionInput: document.getElementById('edit-project-description-input'), 
            editProjectImageUploadInput: document.getElementById('edit-project-image-upload'),
            editProjectImagePreview: document.getElementById('edit-image-preview'),
            editProjectDeadlineDateInput: document.getElementById('edit-project-deadline-date'),
            deleteProjectModalBtn: document.getElementById('delete-project-btn-modal'), 
            cancelEditProjectBtn: document.getElementById('cancel-edit-project-btn'),
            noteForm: document.getElementById('note-form'),
            noteProjectIdInput: document.getElementById('note-project-id'),
            noteTitleInput: document.getElementById('note-title'),
            noteContentInput: document.getElementById('note-content'),
            noteTagsInput: document.getElementById('note-tags'),
            cancelNoteBtn: document.getElementById('cancel-note-btn'),
            noteEditorOverlay: document.getElementById('note-editor-overlay'),
            noteEditorContainer: document.querySelector('.note-editor-container'),
            noteEditorTitle: document.getElementById('note-editor-title'),
            closeNoteEditorBtn: document.getElementById('close-note-editor-btn'),
            quillEditorInnerContainer: document.getElementById('quill-editor-inner-container'), 
            saveEditedNoteBtn: document.getElementById('save-edited-note-btn'),
            deleteCurrentNoteBtn: document.getElementById('delete-current-note-btn'),
            toastContainer: document.getElementById('toast-container'),
            dataArea: document.getElementById('data-area'),
            backupBtn: document.getElementById('backup-btn'),
            restoreBtn: document.getElementById('restore-btn'),
            restoreInput: document.getElementById('restore-input'),
            lastBackupInfo: document.getElementById('last-backup-info'),
            addWeeklyTaskModal: document.getElementById('add-weekly-task-modal'),
            editWeeklyTaskModal: document.getElementById('edit-weekly-task-modal'),
            weeklyTaskForm: document.getElementById('weekly-task-form'),
            weeklyTaskTitleInput: document.getElementById('weekly-task-title'),
            weeklyTaskMinutesInput: document.getElementById('weekly-task-minutes'),
            cancelWeeklyTaskBtn: document.getElementById('cancel-weekly-task-btn'),
            editWeeklyTaskForm: document.getElementById('edit-weekly-task-form'),
            editWeeklyIdInput: document.getElementById('edit-weekly-id'),
            editWeeklyTaskTitleInput: document.getElementById('edit-weekly-task-title'),
            editWeeklyTaskMinutesInput: document.getElementById('edit-weekly-task-minutes'),
            deleteWeeklyTaskBtn: document.getElementById('delete-weekly-task-btn'),
            cancelEditWeeklyTaskBtn: document.getElementById('cancel-edit-weekly-btn'),
            weeklyDotsGrid: document.getElementById('weekly-dots-grid')
        };
        const allModalCloseBtns = document.querySelectorAll('.modal .close-modal');
        const allModalCancelBtns = document.querySelectorAll('.modal .cancel-btn');


        // --- Dexie Helper Functions ---
        async function getAllDexie(storeName) { return db.table(storeName).toArray(); }
        async function getDexie(storeName, key) { return db.table(storeName).get(key); }
        async function addDexie(storeName, item) {
            const result = await db.table(storeName).add(item);
            if (window.save) window.save();
            return result;
        }
        async function putDexie(storeName, item) {
            const result = await db.table(storeName).put(item);
            if (window.save) window.save();
            return result;
        }
        async function deleteDexieItem(storeName, key) {
            const result = await db.table(storeName).delete(key);
            if (window.save) window.save();
            return result;
        }
        async function clearDexieStore(storeName) {
            const result = await db.table(storeName).clear();
            if (window.save) window.save();
            return result;
        }

        
        // --- Utility Functions ---
        function formatDate(dateString) {
            if (!dateString) return ''; const date = new Date(dateString);
            return date.toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric' }); 
        }
        function formatDateTime(dateString) {
            if (!dateString) return ''; const date = new Date(dateString);
            return date.toLocaleDateString('en-CA', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        }
        function truncateText(text, maxLength) { return !text ? '' : (text.length > maxLength ? text.substring(0, maxLength) + '...' : text); }
        function capitalizeFirstLetter(string) { return !string ? '' : string.charAt(0).toUpperCase() + string.slice(1); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }
        function uuid() {
            return (window.crypto && typeof window.crypto.randomUUID === 'function')
                ? window.crypto.randomUUID()
                : generateId();
        }
        async function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                if (!window.FileReader) return reject(new Error('FileReader not supported'));
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- Toast Notifications ---
        function showToast(message, type = 'info', duration = 3500) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            else if (type === 'error') iconClass = 'fas fa-times-circle';
            else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            toast.innerHTML = `<div class="toast-icon"><i class="${iconClass}"></i></div><div class="toast-message">${message}</div><button class="toast-close">&times;</button>`;
            .toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            const closeBtn = toast.querySelector('.toast-close');
            const removeToast = () => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); };
            closeBtn.addEventListener('click', removeToast);
            setTimeout(removeToast, duration);
        }

        function getWeekStart(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0,0,0,0);
            return d.toISOString().split('T')[0];
        }
        function getWeeklyLog(taskId, weekStart) {
            return weeklyLogs.find(l => l.taskId === taskId && l.weekStart === weekStart);
        }
        function ensureCurrentWeekLog(taskId) {
            const weekStart = getWeekStart();
            let log = getWeeklyLog(taskId, weekStart);
            if (!log) {
                log = { taskId, weekStart, minutes: 0, planned: false, completed: false };
                weeklyLogs.push(log);
                addDexie(STORES.WEEKLY_LOGS, log);
            }
            return log;
        }

        // --- Data Loading & Saving ---
       async function loadDataFromDB() {
            try {
                [tasks, quickTasks, projects, concepts, notes, folders, weeklyTasks, weeklyLogs] = await Promise.all([
                    getAllDexie(STORES.TASKS), getAllDexie(STORES.QUICK_TASKS),
                    getAllDexie(STORES.PROJECTS), getAllDexie(STORES.CONCEPTS), getAllDexie(STORES.NOTES),
                    getAllDexie(STORES.FOLDERS), getAllDexie(STORES.WEEKLY_TASKS), getAllDexie(STORES.WEEKLY_LOGS)
                ]);
                const tagObjects = await getAllDexie(STORES.TAGS) || []; tags = tagObjects.map(t => t.tag).sort();

                const settingsArray = await getAllDexie(STORES.SETTINGS);
                settingsArray.forEach(s => {
                    if (s.key === 'currentView') currentView = s.value;
                    else if (s.key === 'currentSort') currentSort = s.value;
                    else if (s.key === 'projectsViewMode') projectsViewMode = s.value;
                    else if (s.key === 'notesSort') notesSort = s.value;
                    else if (s.key === 'lastBackup') lastBackup = s.value;
                });
            } catch (error) { console.error('Error loading data:', error); showToast('Error loading data.', 'error'); }
        }
        async function saveData(storeName, dataToSave, isSingleItem = false) {
            try {
                if (isSingleItem) {
                    await putDexie(storeName, dataToSave);
                } else {
                    await clearDexieStore(storeName);
                    if (storeName === STORES.TAGS) {
                        if (dataToSave.length > 0) await db.table(storeName).bulkPut(dataToSave.map(tagStr => ({ tag: tagStr })));
                    } else if (dataToSave.length > 0) {
                        await db.table(storeName).bulkPut(dataToSave);
                    }
                }
                if (window.save) window.save();
            } catch (error) { console.error(`Error saving to ${storeName}:`, error); showToast(`Error saving to ${storeName}.`, 'error'); }
        }
        async function saveSetting(key, value) { await putDexie(STORES.SETTINGS, { key, value }); }



        // --- Priority Calculation ---
        function calculatePriority(task) {
            const impW = { super: 5, high: 3, normal: 1 }[task.importance || 'normal'];
            let dlScore = 0;
            if (task.deadline) {
                const days = Math.floor((new Date(task.deadline) - new Date()) / (1000*60*60*24));
                if (days <= 3) return 10000 + (impW * 30) + (task.projectId ? 5 : 0);
                else if (days <= 7) dlScore = 2; else dlScore = 1;
            }
            return (impW * 30) + (dlScore * 20) + (task.projectId ? 5 : 0);
        }
        function updateAllTaskPriorities(save = true) {
            let changed = false;
            tasks.forEach(task => { const newP = calculatePriority(task); if (task.priority !== newP) { task.priority = newP; changed = true; } });
            if (changed && save) saveData(STORES.TASKS, tasks); return changed;
        }

        // --- Task Rendering & Management ---
        function renderTasks() {
            .tasksList.innerHTML = '';
            if (['quick', 'projects', 'concepts', 'project-detail', 'concept-detail', 'note-editor'].includes(currentView)) {
                 .tasksList.classList.add('hidden'); return;
            }
            .tasksList.classList.remove('hidden');

            let filtered = tasks.filter(task => {
                if (currentView === 'active' && (task.status !== 'active' || task.completed)) return false;
                if (currentView === 'waiting') {
                    if (task.completed) return false;
                    const project = task.projectId ? projects.find(p => p.id === task.projectId) : null;
                    if (project && project.status === 'storage') return false; 
                    return task.status === 'waiting' || (project && project.status === 'waiting' && task.status === 'active');
                }
                if (currentView === 'completed' && !task.completed) return false;
                if (activeFilters.length > 0 && !task.tags.some(tag => activeFilters.includes(tag))) return false;
                if (projectFilters.length > 0 && (!task.projectId || !projectFilters.includes(task.projectId))) return false;
                return true;
            });
            updateAllTaskPriorities(false); 
            filtered.sort((a, b) => {
                if (currentView !== 'completed' && a.completed !== b.completed) return a.completed ? 1 : -1; 
                switch (currentSort) {
                    case 'priority': return b.priority - a.priority;
                    case 'deadline': 
                        const dateA = a.deadline ? new Date(a.deadline) : null;
                        const dateB = b.deadline ? new Date(b.deadline) : null;
                        if (dateA === null && dateB === null) return 0;
                        if (dateA === null) return 1; 
                        if (dateB === null) return -1; 
                        return dateA - dateB;
                    case 'importance': const iV = { super: 3, high: 2, normal: 1 }; return (iV[b.importance]||1) - (iV[a.importance]||1);
                    case 'created': return new Date(b.createdAt) - new Date(a.createdAt);
                    default: return 0;
                }
            });
            if (filtered.length === 0) { .tasksList.innerHTML = `<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>No tasks match the current view/filters.</p></div>`; return; }
            filtered.forEach((task, i) => .tasksList.appendChild(createTaskElement(task, i)));
        }
        function createTaskElement(task, index) {
            const el = document.createElement('div');
            el.className = `task-card status-${task.status} ${task.completed ? 'completed' : ''} importance-${task.importance||'normal'}`;
            el.dataset.id = task.id; el.style.animationDelay = `${index * 0.03}s`;
            let dlStr = '', dlClass = '';
            if (task.deadline) {
                const d = new Date(task.deadline), now = new Date();
                const days = Math.ceil((d.setHours(0,0,0,0) - now.setHours(0,0,0,0)) / 864e5); 
                if (days < 0) { dlStr = 'Overdue!'; dlClass = 'urgent'; }
                else if (days === 0) { dlStr = 'Today'; dlClass = 'urgent'; }
                else if (days === 1) { dlStr = 'Tomorrow'; dlClass = 'near-deadline'; }
                else dlStr = formatDate(task.deadline);
            }
            const proj = task.projectId ? projects.find(p => p.id === task.projectId) : null;
            const priorityDisplay = Math.max(1, Math.min(6, Math.floor(task.priority / 25) + 1)); 

            el.innerHTML = `
                <div class="task-header">
                    <h4 class="task-title">${truncateText(task.title, 50)}</h4>
                    ${!task.completed ? `<div class="task-priority priority-val-${priorityDisplay}">${task.priority}</div>` : ''}
                </div>
                ${task.description ? `<p class="task-description">${truncateText(task.description, 90)}</p>` : ''}
                <div class="task-meta">
                    ${task.deadline ? `<span class="task-meta-item task-deadline ${dlClass}"><i class="far fa-calendar-alt"></i>${dlStr}</span>` : ''}
                    <span class="task-meta-item task-importance"><i class="fas fa-star"></i>${capitalizeFirstLetter(task.importance || 'normal')}</span>
                    <span class="task-meta-item task-created"><i class="far fa-clock"></i>${formatDate(task.createdAt)}</span>
                </div>
                ${proj ? `<div class="task-project">Project: ${truncateText(proj.title, 25)} (${capitalizeFirstLetter(proj.status)})</div>` : ''}
                ${task.tags && task.tags.length > 0 ? `<div class="task-tags">${task.tags.map(t => `<span class="task-tag">${t}</span>`).join('')}</div>` : ''}
                <div class="task-actions">
                    <button class="task-action-btn task-complete-btn" title="${task.completed?'Mark Incomplete':'Mark Complete'}"><i class="fas ${task.completed?'fa-undo-alt':'fa-check'}"></i></button>
                    <button class="task-action-btn task-edit-btn" title="Edit Task"><i class="fas fa-pencil-alt"></i></button>
                    ${!task.completed && task.status !== 'waiting' ? `<button class="task-action-btn move-to-waiting-btn" title="Move to Waiting"><i class="fas fa-pause-circle"></i></button>` : ''}
                    ${!task.completed && task.status === 'waiting' ? `<button class="task-action-btn move-to-active-btn" title="Move to Active"><i class="fas fa-play-circle"></i></button>` : ''}
                </div>`;
            el.querySelector('.task-complete-btn').addEventListener('click', () => toggleTaskCompletion(task.id, el));
            el.querySelector('.task-edit-btn').addEventListener('click', () => openEditTaskModal(task.id));
            const waitBtn = el.querySelector('.move-to-waiting-btn'); if(waitBtn) waitBtn.addEventListener('click', () => quickChangeTaskStatus(task.id, 'waiting'));
            const activeBtn = el.querySelector('.move-to-active-btn'); if(activeBtn) activeBtn.addEventListener('click', () => quickChangeTaskStatus(task.id, 'active'));
            return el;
        }
        async function quickChangeTaskStatus(id, newStatus) {
            const taskIndex = tasks.findIndex(t => t.id === id); if (taskIndex === -1) return;
            tasks[taskIndex].status = newStatus;
            tasks[taskIndex].updatedAt = new Date().toISOString();
            tasks[taskIndex].priority = calculatePriority(tasks[taskIndex]);
            await putDexie(STORES.TASKS, tasks[taskIndex]);
            renderTasks(); if (currentProjectId === tasks[taskIndex].projectId) renderProjectTasks(currentProjectId);
            showToast(`Task moved to ${newStatus}.`, 'success');
        }
        async function toggleTaskCompletion(id, el) {
            const taskIndex = tasks.findIndex(t => t.id === id); if (taskIndex === -1) return;
            tasks[taskIndex].completed = !tasks[taskIndex].completed; 
            tasks[taskIndex].completedAt = tasks[taskIndex].completed ? new Date().toISOString() : null;
            tasks[taskIndex].updatedAt = new Date().toISOString();
            tasks[taskIndex].priority = calculatePriority(tasks[taskIndex]);
            
            if (tasks[taskIndex].completed && el && currentView !== 'completed') {
                el.classList.add('task-complete-animation');
                await putDexie(STORES.TASKS, tasks[taskIndex]);
                setTimeout(() => {
                    renderTasks();
                    if (currentProjectId === tasks[taskIndex].projectId) renderProjectTasks(currentProjectId);
                }, 500); 
            } else {
                await putDexie(STORES.TASKS, tasks[taskIndex]);
                renderTasks();
                if (currentProjectId === tasks[taskIndex].projectId) renderProjectTasks(currentProjectId);
            }
        }
        async function deleteTask(id, fromModal = false) {
            if (!confirm("Are you sure you want to delete this task?")) return;
            const taskToDelete = tasks.find(t=>t.id === id);
            tasks = tasks.filter(t => t.id !== id);
            await deleteDexieItem(STORES.TASKS, id);
            renderTasks();
            if (currentProjectId && taskToDelete && taskToDelete.projectId === currentProjectId) renderProjectTasks(currentProjectId);
            if (fromModal) closeModal(.editTaskModal);
            showToast('Task deleted.', 'success');
        }

        // --- Tag & Project Filters & Management ---
        function updateUniqueTags(newTagsArray) {
            let changed = false;
            newTagsArray.forEach(tag => {
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    changed = true;
                }
            });
            if (changed) {
                tags.sort();
                saveData(STORES.TAGS, tags, false); 
                renderTagFilters();
                renderManageTags();
                if (.addTaskModal.classList.contains('visible')) {
                    renderSuggestedTags(.taskTagsInput.value.split(',').map(t => t.trim()).filter(t => t), .suggestedTagsContainer, .taskTagsInput);
                }
                 if (.editTaskModal.classList.contains('visible')) {
                    renderSuggestedTags(.editTaskTagsInput.value.split(',').map(t => t.trim()).filter(t => t), .editSuggestedTagsContainer, .editTaskTagsInput);
                }
            }
        }
        function renderTagFilters() {
            .tagFiltersContainer.innerHTML = '';
            if (tags.length === 0) {
                .tagFiltersContainer.innerHTML = '<p style="font-size:0.9em; opacity:0.7;">No tags available.</p>'; return;
            }
            tags.forEach(tag => {
                const el = document.createElement('button');
                el.className = `tag-filter ${activeFilters.includes(tag) ? 'active' : ''}`;
                el.textContent = tag;
                el.dataset.tag = tag;
                el.addEventListener('click', () => toggleTagFilter(tag));
                .tagFiltersContainer.appendChild(el);
            });
        }
        function toggleTagFilter(tag) {
            if (activeFilters.includes(tag)) activeFilters = activeFilters.filter(f => f !== tag);
            else activeFilters.push(tag);
            renderTagFilters(); renderTasks();
        }
        function renderProjectFilters() {
            .projectFiltersContainer.innerHTML = '';
            const activeProjs = projects.filter(p => p.status === 'active' || p.status === 'waiting');
            if (activeProjs.length === 0) {
                .projectFiltersContainer.innerHTML = '<p style="font-size:0.9em; opacity:0.7;">No active/waiting projects.</p>'; return;
            }
            activeProjs.sort((a,b) => a.title.localeCompare(b.title)).forEach(project => {
                const el = document.createElement('button');
                el.className = `tag-filter project-filter status-${project.status} ${projectFilters.includes(project.id) ? 'active' : ''}`;
                el.textContent = project.title;
                el.dataset.projectId = project.id;
                el.addEventListener('click', () => toggleProjectFilter(project.id));
                .projectFiltersContainer.appendChild(el);
            });
        }
        function toggleProjectFilter(projectId) {
            if (projectFilters.includes(projectId)) projectFilters = projectFilters.filter(id => id !== projectId);
            else projectFilters.push(projectId);
            renderProjectFilters(); renderTasks();
        }
        function renderManageTags() {
            .manageTagsContainer.innerHTML = '';
             if (tags.length === 0) {
                .manageTagsContainer.innerHTML = '<p style="font-size:0.9em; opacity:0.7;">No tags to manage.</p>'; return;
            }
            tags.forEach(tag => {
                const el = document.createElement('div');
                el.className = 'manage-item';
                el.innerHTML = `<span>${tag}</span><button class="manage-item-remove" data-tag="${tag}"><i class="fas fa-times"></i></button>`;
                el.querySelector('.manage-item-remove').addEventListener('click', () => removeTag(tag));
                .manageTagsContainer.appendChild(el);
            });
        }
        async function removeTag(tagToRemove) {
            if (!confirm(`Are you sure you want to remove the tag "${tagToRemove}"? It will be removed from all tasks.`)) return;
            tags = tags.filter(t => t !== tagToRemove);
            tasks.forEach(task => { task.tags = task.tags.filter(tt => tt !== tagToRemove); });
            notes.forEach(note => { note.tags = note.tags.filter(nt => nt !== tagToRemove); }); 

            await saveData(STORES.TAGS, tags, false); 
            await saveData(STORES.TASKS, tasks);
            await saveData(STORES.NOTES, notes);

            renderTagFilters(); renderManageTags(); renderTasks();
            if (currentView === 'project-detail') { renderNotes(currentProjectId); renderNoteTagFilters(currentProjectId); }
            showToast(`Tag "${tagToRemove}" removed.`, 'success');
        }

        // --- Projects Rendering & Management ---
        function renderProjects() {
            const searchTerm = .projectSearchInput.value.toLowerCase();
            const statusFilter = .projectStatusFilter.value;
            
            let filteredProjects = projects.filter(p => {
                const titleMatch = p.title.toLowerCase().includes(searchTerm);
                const statusMatch = statusFilter === 'all' || p.status === statusFilter;
                const folderMatch = (currentFolderId ? p.folderId === currentFolderId : !p.folderId);
                return titleMatch && statusMatch && folderMatch;
            });

            const foldersInView = folders.filter(f => f.parentId === currentFolderId);

            if (currentFolderId) {
                const currentFolder = folders.find(f=>f.id===currentFolderId);
                .folderNav.classList.remove('hidden');
                .currentFolderName.textContent = currentFolder ? currentFolder.name : '';
            } else {
                .folderNav.classList.add('hidden');
                .currentFolderName.textContent = '';
            }

            filteredProjects.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 

            if (projectsViewMode === 'grid') {
                .projectsGrid.innerHTML = '';
                foldersInView.forEach((f,i) => .projectsGrid.appendChild(createFolderGridElement(f,i)));
                if (filteredProjects.length === 0 && foldersInView.length === 0) .projectsGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-folder-open"></i><p>No projects found.</p></div>`;
                else filteredProjects.forEach((p, i) => .projectsGrid.appendChild(createProjectGridElement(p,i)));
            } else {
                .projectsListContainer.innerHTML = '';
                foldersInView.forEach((f,i) => .projectsListContainer.appendChild(createFolderListElement(f,i)));
                if (filteredProjects.length === 0 && foldersInView.length === 0) .projectsListContainer.innerHTML = `<div class="empty-state"><i class="fas fa-folder-open"></i><p>No projects found.</p></div>`;
                else filteredProjects.forEach((p,i) => .projectsListContainer.appendChild(createProjectListElement(p,i)));
            }
        }
        function createFolderGridElement(folder, index) {
            const el = document.createElement('div');
            el.className = 'folder-card';
            el.dataset.id = folder.id;
            el.style.animationDelay = `${index * 0.03}s`;
            el.innerHTML = `<div class="folder-icon" style="color:${folder.color}"><i class="fas fa-folder"></i></div><div class="folder-name">${truncateText(folder.name,30)}</div>`;
            el.addEventListener('click', () => { currentFolderId = folder.id; renderProjects(); });
            el.addEventListener('dragover', e => e.preventDefault());
            el.addEventListener('drop', e => { const pid = e.dataTransfer.getData('text/plain'); moveProjectToFolder(pid, folder.id); });
            return el;
        }
        function createFolderListElement(folder, index) {
            const el = document.createElement('div');
            el.className = 'folder-list-item';
            el.dataset.id = folder.id;
            el.style.animationDelay = `${index * 0.02}s`;
            el.innerHTML = `<span class="folder-icon" style="color:${folder.color}"><i class="fas fa-folder"></i></span><span class="folder-name">${truncateText(folder.name,40)}</span>`;
            el.addEventListener('click', () => { currentFolderId = folder.id; renderProjects(); });
            el.addEventListener('dragover', e => e.preventDefault());
            el.addEventListener('drop', e => { const pid = e.dataTransfer.getData('text/plain'); moveProjectToFolder(pid, folder.id); });
            return el;
        }
        function createProjectGridElement(project, index) {
            const el = document.createElement('div'); el.className = `project-card status-${project.status}`; el.dataset.id = project.id; el.style.animationDelay = `${index * 0.03}s`; el.draggable = true;
            const imgStyle = project.imageData ? `background-image:url('${project.imageData}')` : `background-color:var(--input-bg-color);`;
            const imgContent = !project.imageData ? `<div class="no-image-placeholder"><i class="fas fa-folder-open"></i></div>` : '';
            const tasksInProj = tasks.filter(t => t.projectId === project.id);
            const activeT = tasksInProj.filter(t => !t.completed && t.status === 'active').length;
            const waitingT = tasksInProj.filter(t => !t.completed && t.status === 'waiting').length;
            el.innerHTML = `
                <div class="project-image" style="${imgStyle}">${imgContent}<div class="project-status-badge">${capitalizeFirstLetter(project.status)}</div></div>
                <div class="project-content">
                    <h4 class="project-title">${truncateText(project.title,35)}</h4>
                    ${project.description ? `<p class="project-description">${truncateText(project.description,70)}</p>` : ''}
                    <div class="project-meta">
                        ${project.deadline ? `<span class="project-meta-item"><i class="far fa-calendar-check"></i>${formatDate(project.deadline)}</span>` : ''}
                        <span class="project-meta-item"><i class="fas fa-tasks"></i>${tasksInProj.length} tasks</span>
                        <span class="project-meta-item"><i class="fas fa-stream"></i>${activeT} active, ${waitingT} waiting</span>
                    </div>
                    <button class="project-toggle-status action-btn" title="Cycle Status"><i class="fas fa-sync-alt"></i> Cycle Status</button>
                </div>`;
            el.addEventListener('click', e => { if (!e.target.closest('.project-toggle-status')) openProjectDetail(project.id); });
            el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', project.id); });
            el.querySelector('.project-toggle-status').addEventListener('click', e => { e.stopPropagation(); toggleProjectStatusCycle(project.id); });
            return el;
        }
        function createProjectListElement(project, index) {
            const el = document.createElement('div');
            el.className = `project-list-item status-${project.status}`;
            el.dataset.id = project.id;
            el.style.animationDelay = `${index * 0.02}s`;
            el.draggable = true;

            const tasksInProj = tasks.filter(t => t.projectId === project.id);
            const activeT = tasksInProj.filter(t => !t.completed && t.status === 'active').length;
            const waitingT = tasksInProj.filter(t => !t.completed && t.status === 'waiting').length;
            const completedT = tasksInProj.filter(t => t.completed).length;

            el.innerHTML = `
                <div class="project-list-status">${capitalizeFirstLetter(project.status)}</div>
                <div class="project-list-main">
                    <h4 class="project-title">${truncateText(project.title, 50)}</h4>
                    <div class="project-list-meta">
                        <span><i class="far fa-calendar-alt"></i> Created: ${formatDate(project.createdAt)}</span>
                        ${project.deadline ? `<span><i class="far fa-calendar-check"></i> Deadline: ${formatDate(project.deadline)}</span>` : ''}
                        <span><i class="fas fa-tasks"></i> ${tasksInProj.length} Tasks (${completedT} done)</span>
                         <span><i class="fas fa-stream"></i> ${activeT} active, ${waitingT} waiting</span>
                    </div>
                </div>
                <button class="project-toggle-status action-btn" title="Cycle Status"><i class="fas fa-sync-alt"></i> Cycle</button>
            `;
            el.addEventListener('click', e => { if (!e.target.closest('.project-toggle-status')) openProjectDetail(project.id); });
            el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', project.id); });
            el.querySelector('.project-toggle-status').addEventListener('click', e => { e.stopPropagation(); toggleProjectStatusCycle(project.id); });
            return el;
        }
        async function toggleProjectStatusCycle(id) {
            const projectIndex = projects.findIndex(p => p.id === id);
            if (projectIndex === -1) return;
            const project = projects[projectIndex];
            const statuses = ['active', 'waiting', 'storage', 'completed'];
            let currentStatusIndex = statuses.indexOf(project.status);
            currentStatusIndex = (currentStatusIndex + 1) % statuses.length;
            project.status = statuses[currentStatusIndex];
            project.updatedAt = new Date().toISOString();



            await putDexie(STORES.PROJECTS, project);
            renderProjects(); renderProjectFilters(); renderTasks();
            showToast(`Project "${truncateText(project.title,20)}" status changed to ${project.status}.`, 'success');
        }

async function addFolder() {
            const name = prompt('Folder name?');
            if (!name) return;
            const color = prompt('Folder color (name or hex)', '#4F7FFF') || '#4F7FFF';
            const folder = { id: generateId(), name, color, parentId: currentFolderId, createdAt: new Date().toISOString() };
            folders.push(folder);
            await addDexie(STORES.FOLDERS, folder);
            renderProjects();
}

async function renameFolder(id) {
            const folder = folders.find(f => f.id === id);
            if (!folder) { showToast('Folder not found.', 'error'); return; }
            const newName = prompt('New folder name:', folder.name);
            if (!newName) return;
            folder.name = newName.trim();
            const newColor = prompt('Folder color (name or hex):', folder.color) || folder.color;
            folder.color = newColor;
            await putDexie(STORES.FOLDERS, folder);
            renderProjects();
            showToast('Folder renamed.', 'success');
        }

        async function deleteFolder(id) {
            const folderToDelete = folders.find(f => f.id === id);
            if (!folderToDelete) { showToast('Folder not found.', 'error'); return; }
            if (!confirm('Delete this folder? Projects and subfolders will move up one level.')) return;

            const parentId = folderToDelete.parentId || null;

            const projectsToMove = projects.filter(p => p.folderId === id);
            for (const proj of projectsToMove) {
                proj.folderId = parentId;
                proj.updatedAt = new Date().toISOString();
                await putDexie(STORES.PROJECTS, proj);
            }

            const subFolders = folders.filter(f => f.parentId === id);
            for (const sf of subFolders) {
                sf.parentId = parentId;
                await putDexie(STORES.FOLDERS, sf);
            }

            folders = folders.filter(f => f.id !== id);
            await deleteDexieItem(STORES.FOLDERS, id);

            if (currentFolderId === id) currentFolderId = parentId;

            renderProjects();
            showToast('Folder deleted.', 'success');
        }

        async function moveProjectToFolder(projectId, folderId) {
            const idx = projects.findIndex(p => p.id === projectId);
            if (idx === -1) return;
            projects[idx].folderId = folderId;
            projects[idx].updatedAt = new Date().toISOString();
            await putDexie(STORES.PROJECTS, projects[idx]);
            renderProjects();
        }

        function renderWeeklyTasks() {
            .weeklyTasksList.innerHTML = '';
            if (weeklyTasks.length === 0) {
                .weeklyTasksList.innerHTML = '<div class="empty-state"><p>No weekly tasks.</p></div>';
                renderWeeklyDots();
                return;
            }
            weeklyTasks.forEach(task => {
                .weeklyTasksList.appendChild(createWeeklyTaskElement(task));
            });
            renderWeeklyDots();
        }
        function createWeeklyTaskElement(task) {
            const log = ensureCurrentWeekLog(task.id);
            if(!log.completed && log.minutes >= task.targetMinutes) { log.completed = true; putDexie(STORES.WEEKLY_LOGS, log); }
            const el = document.createElement('div');
            const status = log.completed ? 'completed' : (log.planned ? 'planned' : 'not');
            const percent = Math.min(100, (log.minutes / task.targetMinutes) * 100);
            el.className = `weekly-task-card status-${status}`;
            el.innerHTML = `
                <div class="weekly-task-header"><span>${truncateText(task.title,40)}</span><span>${task.targetMinutes}m</span></div>
                <div class="weekly-progress-bar"><div class="weekly-progress-bar-inner" style="width:${percent}%"></div></div>
                <div class="weekly-input-row"><span>${log.minutes} / ${task.targetMinutes}m</span>
                    <input type="number" class="weekly-time-input" placeholder="min">
                    <button class="task-action-btn weekly-add-time" title="Add Time" style="background-color:var(--warning-color);color:var(--primary-color);"><i class="fas fa-level-down-alt"></i></button>
                    <button class="task-action-btn weekly-plan" title="Planned" style="background-color:var(--accent-color);color:var(--primary-color);"><i class="fas fa-calendar-check"></i></button>
                    <button class="task-action-btn weekly-edit" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="task-action-btn weekly-delete" title="Delete" style="background-color:var(--danger-color);color:var(--primary-color);"><i class="fas fa-trash"></i></button>
                </div>`;
            const input = el.querySelector('.weekly-time-input');
            el.querySelector('.weekly-add-time').addEventListener('click', () => {
                const val = parseInt(input.value,10); if (!val) return; const logObj = ensureCurrentWeekLog(task.id); logObj.minutes += val; if(logObj.minutes >= task.targetMinutes) logObj.completed = true; putDexie(STORES.WEEKLY_LOGS, logObj); input.value=''; renderWeeklyTasks();
            });
            el.querySelector('.weekly-plan').addEventListener('click', () => { const logObj = ensureCurrentWeekLog(task.id); logObj.planned = true; putDexie(STORES.WEEKLY_LOGS, logObj); renderWeeklyTasks(); });
            el.querySelector('.weekly-edit').addEventListener('click', () => editWeeklyTask(task.id));
            el.querySelector('.weekly-delete').addEventListener('click', () => deleteWeeklyTask(task.id));
            return el;
        }
        function renderWeeklyDots() {
            if (!.weeklyDotsGrid) return;
            .weeklyDotsGrid.querySelectorAll('.weekly-dot').forEach(d => d.remove());
            const empty = .weeklyDotsGrid.querySelector('.empty-state');
            if (weeklyTasks.length === 0) {
                if (empty) empty.classList.remove('hidden');
                return;
            }
            if (empty) empty.classList.add('hidden');
            weeklyTasks.forEach(task => {
                const log = ensureCurrentWeekLog(task.id);
                const dot = document.createElement('div');
                dot.className = 'weekly-dot';
                dot.style.backgroundColor = log.completed ? 'var(--success-color)' : (log.planned ? 'var(--accent-color)' : 'var(--danger-color)');
                .weeklyDotsGrid.appendChild(dot);
            });
        }
        function openAddWeeklyTaskModal() { openModal(.addWeeklyTaskModal); }
        function openEditWeeklyTaskModal(id) {
            const task = weeklyTasks.find(t=>t.id===id); if(!task) return;
            openModal(.editWeeklyTaskModal);
            .editWeeklyIdInput.value = task.id;
            .editWeeklyTaskTitleInput.value = task.title;
            .editWeeklyTaskMinutesInput.value = task.targetMinutes;
        }
        async function handleWeeklyTaskFormSubmit(isEdit=false) {
            const title = (isEdit?.editWeeklyTaskTitleInput:.weeklyTaskTitleInput).value.trim();
            const mins = parseInt((isEdit?.editWeeklyTaskMinutesInput:.weeklyTaskMinutesInput).value,10);
            if(!title || !mins) { showToast('Title and minutes required','error'); return; }
            if(isEdit) {
                const id = .editWeeklyIdInput.value;
                const task = weeklyTasks.find(t=>t.id===id);
                if(!task) return;
                task.title = title;
                task.targetMinutes = mins;
                await putDexie(STORES.WEEKLY_TASKS, task);
            } else {
                const task = {id:generateId(), title, targetMinutes:mins};
                weeklyTasks.push(task);
                await addDexie(STORES.WEEKLY_TASKS, task);
                ensureCurrentWeekLog(task.id);
            }
            renderWeeklyTasks();
            closeModal(isEdit?.editWeeklyTaskModal:.addWeeklyTaskModal);
        }
        async function editWeeklyTask(id) { openEditWeeklyTaskModal(id); }
        async function deleteWeeklyTask(id) {
            if (!confirm('Delete this weekly task?')) return;
            weeklyTasks = weeklyTasks.filter(t=>t.id!==id);
            await deleteDexieItem(STORES.WEEKLY_TASKS, id);
            weeklyLogs = weeklyLogs.filter(l=>l.taskId!==id);
            await db.table(STORES.WEEKLY_LOGS).where('taskId').equals(id).delete();
            renderWeeklyTasks();
        }
        function showWeeklyHistory() {
            let msg = '';
            weeklyTasks.forEach(task => {
                msg += `${task.title}\n`;
                const logs = weeklyLogs.filter(l=>l.taskId===task.id).sort((a,b)=> new Date(a.weekStart)-new Date(b.weekStart));
                logs.forEach(l=>{ msg+=`  ${l.weekStart}: ${l.minutes}/${task.targetMinutes}m ${l.completed?'':''}\n`; });
            });
            alert(msg || 'No history');
        }
        function setProjectsViewMode(mode) {
            projectsViewMode = mode;
            saveSetting('projectsViewMode', mode);
            setProjectsViewModeUI();
            renderProjects();
        }
        function setProjectsViewModeUI() {
            if (projectsViewMode === 'grid') {
                .gridViewBtn.classList.add('active'); .listViewBtn.classList.remove('active');
                .projectsGrid.classList.remove('hidden'); .projectsListContainer.classList.add('hidden');
            } else {
                .listViewBtn.classList.add('active'); .gridViewBtn.classList.remove('active');
                .projectsListContainer.classList.remove('hidden'); .projectsGrid.classList.add('hidden');
            }
        }
        function openProjectDetail(id) {
            const project = projects.find(p => p.id === id);
            if (!project) { showToast('Project not found.', 'error'); return; }
            currentProjectId = id;
            renderProjectDetail(project); 
            setCurrentView('project-detail'); // This will remove .hidden from projectDetailView
            setActiveTab('overview'); 
        }
        function renderProjectDetail(project) { // Renders only the static parts of project detail
            .projectDetailTitle.textContent = project.title;
            if (project.imageData) {
                .projectDetailImage.style.backgroundImage = `url('${project.imageData}')`;
                .projectDetailImage.innerHTML = ''; 
            } else {
                .projectDetailImage.style.backgroundImage = 'none';
                .projectDetailImage.innerHTML = '<div class="no-image-placeholder"><i class="fas fa-image"></i></div>';
            }
            
            let statusHTML = `<span class="status-badge status-${project.status}">${capitalizeFirstLetter(project.status)}</span>`;
            
            .projectDetailStatus.innerHTML = statusHTML;

            let datesHTML = `<span class="date-item"><i class="far fa-clock"></i> Created: ${formatDate(project.createdAt)}</span>`;
            if (project.deadline) {
                datesHTML += `<span class="date-item"><i class="far fa-calendar-check"></i> Deadline: ${formatDate(project.deadline)}</span>`;
            }
            .projectDetailDates.innerHTML = datesHTML;
            // Set overview description directly
            .projectDetailDescription.textContent = project.description || 'No description provided.';
        }
        async function deleteProject(id, fromModal = false) {
            if (!confirm("Are you sure you want to delete this project? All associated tasks and notes will also be deleted.")) return;
            
            projects = projects.filter(p => p.id !== id);
            await deleteDexieItem(STORES.PROJECTS, id);

            const tasksToDelete = tasks.filter(t => t.projectId === id).map(t => t.id);
            tasks = tasks.filter(t => t.projectId !== id);
            if (tasksToDelete.length > 0) await db.table(STORES.TASKS).bulkDelete(tasksToDelete);
            
            const notesToDelete = notes.filter(n => n.projectId === id).map(n => n.id);
            notes = notes.filter(n => n.projectId !== id);
            if (notesToDelete.length > 0) await db.table(STORES.NOTES).bulkDelete(notesToDelete);



            showToast('Project and all associated data deleted.', 'success');
            if (fromModal) closeModal(.editProjectModal);
            
            if (currentView === 'project-detail' && currentProjectId === id) {
                setCurrentView('projects'); 
            } else {
                renderProjects(); 
                renderTasks(); 
                renderProjectFilters(); 
            }
            currentProjectId = null;
        }

        // --- Project Detail Tabs: Tasks ---
        function renderProjectTasks(projectId) {
            .projectTasksList.innerHTML = '';
            const projectTasks = tasks.filter(task => task.projectId === projectId)
                .sort((a,b) => (a.completed === b.completed) ? (new Date(b.createdAt) - new Date(a.createdAt)) : a.completed ? 1 : -1);

            if (projectTasks.length === 0) {
                .projectTasksList.innerHTML = `<div class="empty-state"><i class="fas fa-check-square"></i><p>No tasks for this project yet. Add one!</p></div>`; return;
            }
            projectTasks.forEach((task, i) => .projectTasksList.appendChild(createProjectTaskElement(task, i)));
        }
        function createProjectTaskElement(task, index) {
            const el = document.createElement('div');
            el.className = `project-task-item status-${task.status} ${task.completed ? 'completed' : ''}`;
            el.dataset.id = task.id;
            el.style.animationDelay = `${index * 0.03}s`;

            let dlStr = '', dlClass = '';
            if (task.deadline) {
                const d = new Date(task.deadline), now = new Date();
                const days = Math.ceil((d.setHours(0,0,0,0) - now.setHours(0,0,0,0)) / 864e5);
                if (days < 0) { dlStr = 'Overdue!'; dlClass = 'urgent'; }
                else if (days === 0) { dlStr = 'Today'; dlClass = 'urgent'; }
                else if (days === 1) { dlStr = 'Tomorrow'; dlClass = 'near-deadline'; }
                else dlStr = formatDate(task.deadline);
            }

            el.innerHTML = `
                <div class="project-task-checkbox">
                    <input type="checkbox" id="ptask-${task.id}" ${task.completed ? 'checked' : ''}>
                </div>
                <div class="project-task-content">
                    <label for="ptask-${task.id}" class="project-task-title">${truncateText(task.title, 60)}</label>
                    ${task.description ? `<p class="project-task-description" style="font-size:0.85em; opacity:0.8;">${truncateText(task.description, 100)}</p>` : ''}
                    <div class="project-task-meta">
                        ${task.deadline ? `<span class="task-deadline ${dlClass}"><i class="far fa-calendar-alt"></i>${dlStr}</span>` : ''}
                        <span><i class="fas fa-star"></i>${capitalizeFirstLetter(task.importance || 'normal')}</span>

                    </div>
                </div>
                <div class="project-task-actions">
                    <button class="task-action-btn edit-ptask-btn" title="Edit Task"><i class="fas fa-pencil-alt"></i></button>
                </div>`;
            el.querySelector('input[type="checkbox"]').addEventListener('change', () => toggleTaskCompletion(task.id, el));
            el.querySelector('.edit-ptask-btn').addEventListener('click', () => openEditTaskModal(task.id));
            return el;
        }

        // --- Project Detail Tabs: Notes ---
        function initializeQuillEditor() {
            if (quillEditor) return; 
            if (!.quillEditorInnerContainer) { console.error("Quill container not found"); return; }
            try {
                quillEditor = new Quill(.quillEditorInnerContainer, {
                    theme: 'snow',
                    modules: { toolbar: [
                        [{'header': [1,2,3,false]}], ['bold','italic','underline','strike'], [{'list':'ordered'},{'list':'bullet'}],
                        [{'color':[]},{'background':[]}], [{'align':[]}], ['link','image','clean'] 
                    ]}
                });
            } catch(e) {
                console.error("Failed to initialize Quill:", e);
                showToast("Error initializing text editor.", "error");
            }
        }
        function openNoteEditor(noteId = null) { 
            if (!currentProjectId && !noteId) { 
                showToast("Cannot create note without a project context here.", "error");
                return;
            }
            initializeQuillEditor(); 
            currentEditingNoteId = noteId;
            const note = noteId ? notes.find(n => n.id === noteId) : null;
            
            .noteEditorTitle.textContent = note ? `Edit: ${truncateText(note.title,25)}` : 'New Project Note';
            if (quillEditor) quillEditor.root.innerHTML = note ? note.content : '';
            else { showToast("Editor not ready.", "error"); return; }
            
            .noteEditorOverlay.classList.add('visible');
        }
        function closeNoteEditor() {
            .noteEditorOverlay.classList.remove('visible');
            currentEditingNoteId = null;
            if (quillEditor) quillEditor.root.innerHTML = '';
        }
        async function saveEditedNote() { 
            if (!quillEditor) { showToast("Editor not available.", "error"); return; }
            const content = quillEditor.root.innerHTML;
            
            if (currentEditingNoteId) { 
                const noteIndex = notes.findIndex(n => n.id === currentEditingNoteId);
                if (noteIndex === -1) { showToast('Error: Note not found.', 'error'); return; }
                notes[noteIndex].content = content;
                notes[noteIndex].updatedAt = new Date().toISOString();
                await putDexie(STORES.NOTES, notes[noteIndex]);
                showToast('Note updated.', 'success');
            } else { 
                showToast('Save function is for existing notes. Use "Add Note" for new ones.', 'warning');
                return;
            }
            renderNotes(currentProjectId); 
            closeNoteEditor();
        }
        async function deleteCurrentNoteFromEditor() {
            if (!currentEditingNoteId || !confirm("Are you sure you want to delete this note?")) return;
            notes = notes.filter(n => n.id !== currentEditingNoteId);
            await deleteDexieItem(STORES.NOTES, currentEditingNoteId);
            renderNotes(currentProjectId);
            closeNoteEditor();
            showToast('Note deleted.', 'success');
        }
        function renderNotes(projectId) {
            .notesGrid.innerHTML = '';
            let projectNotes = notes.filter(note => note.projectId === projectId);

            if (noteActiveFilters.length > 0) {
                projectNotes = projectNotes.filter(note => note.tags.some(tag => noteActiveFilters.includes(tag)));
            }

            if (.notesSortSelect.value === 'title') {
                projectNotes.sort((a,b) => (a.title || "").localeCompare(b.title || ""));
            } else { 
                projectNotes.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            }
            
            if (projectNotes.length === 0) {
                .notesGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><i class="far fa-sticky-note"></i><p>No notes for this project yet.</p></div>`; return;
            }
            projectNotes.forEach((note, i) => .notesGrid.appendChild(createNoteCardElement(note, i)));
        }
        function createNoteCardElement(note, index) {
            const el = document.createElement('div');
            el.className = 'note-card';
            el.dataset.id = note.id;
            el.style.animationDelay = `${index * 0.03}s`;

            const tempDiv = document.createElement('div'); tempDiv.innerHTML = note.content;
            const plainTextContent = tempDiv.textContent || tempDiv.innerText || "";
            
            el.innerHTML = `
                <div class="note-header">
                    <h5 class="note-title">${truncateText(note.title, 30)}</h5>
                    <span class="note-date">${formatDate(note.updatedAt)}</span>
                </div>
                <p class="note-content-preview">${truncateText(plainTextContent, 100)}</p>
                ${note.tags && note.tags.length > 0 ? `<div class="note-tags">${note.tags.map(t => `<span class="note-tag">${t}</span>`).join('')}</div>` : ''}
            `;
            el.addEventListener('click', () => openNoteEditor(note.id)); 
            return el;
        }
        function renderNoteTagFilters(projectId) {
            .noteTagFiltersContainer.innerHTML = '';
            const projectNoteTags = [...new Set(notes.filter(n => n.projectId === projectId).flatMap(n => n.tags))].sort();

            if (projectNoteTags.length === 0) {
                 .noteTagFiltersContainer.innerHTML = '<p style="font-size:0.85em; opacity:0.7;">No tags in project notes.</p>'; return;
            }
            projectNoteTags.forEach(tag => {
                const el = document.createElement('button');
                el.className = `note-tag-filter ${noteActiveFilters.includes(tag) ? 'active' : ''}`;
                el.textContent = tag;
                el.dataset.tag = tag;
                el.addEventListener('click', () => toggleNoteTagFilter(tag, projectId));
                .noteTagFiltersContainer.appendChild(el);
            });
        }
        function toggleNoteTagFilter(tag, projectId) {
            if (noteActiveFilters.includes(tag)) noteActiveFilters = noteActiveFilters.filter(f => f !== tag);
            else noteActiveFilters.push(tag);
            renderNoteTagFilters(projectId); 
            renderNotes(projectId);
        }
        

        // --- Modal Handling ---
        function openModal(modalEl) { 
            modalEl.querySelectorAll('form').forEach(f=>f.reset()); 
            modalEl.querySelectorAll('.image-preview').forEach(p=>p.innerHTML=''); 
            modalEl.querySelectorAll('.hidden-by-default').forEach(el=>el.classList.add('hidden'));
            modalEl.querySelectorAll('#task-project, #edit-task-project').forEach(sel => populateProjectSelect(sel));
            if (modalEl.id === 'add-task-modal') renderSuggestedTags([], .suggestedTagsContainer, .taskTagsInput);
            if (modalEl.id === 'edit-task-modal' && .editTaskTagsInput) { 
                 renderSuggestedTags(.editTaskTagsInput.value.split(',').map(t => t.trim()).filter(t => t), .editSuggestedTagsContainer, .editTaskTagsInput);
            }

            modalEl.classList.add('visible'); 
        }
        function closeModal(modalEl) {
            modalEl.classList.remove('visible');
            modalEl.querySelectorAll('input[type="file"]').forEach(inp => inp.value = '');
            modalEl.querySelectorAll('.image-preview').forEach(p => p.innerHTML = '');
        }
        function openAddTaskModal(forProjectId = null) {
            openModal(.addTaskModal);
            if (forProjectId) {
                .taskProjectSelect.value = forProjectId;
            }
        }
        function openEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) { showToast('Task not found.', 'error'); return; }

            openModal(.editTaskModal);

            populateProjectSelect(.editTaskProjectSelect);

            .editTaskIdInput.value = task.id;
            .editTaskTitleInput.value = task.title;
            .editTaskDescriptionInput.value = task.description || '';
            .editTaskProjectSelect.value = task.projectId || '';
            .editTaskTagsInput.value = task.tags.join(', ');
            renderSuggestedTags(task.tags, .editSuggestedTagsContainer, .editTaskTagsInput);
            .editTaskDeadlineDateInput.value = task.deadline || '';
            
            .editTaskForm.querySelector(`input[name="edit-importance"][value="${task.importance || 'normal'}"]`).checked = true;
            const statusRadio = .editTaskForm.querySelector(`input[name="edit-status"][value="${task.status}"]`);
            if (statusRadio) statusRadio.checked = true; else .editTaskForm.querySelector(`input[name="edit-status"][value="active"]`).checked = true;


        }
        function openAddProjectModal() {
            openModal(.addProjectModal);
            .projectImageUploadInput.value = '';
            .projectImagePreview.innerHTML = '';
        }
        function openEditProjectModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) { showToast('Project not found.', 'error'); return; }

            openModal(.editProjectModal);

            .editProjectForm.reset();
            .editProjectIdInput.value = project.id;
            .editProjectTitleInput.value = project.title;
            .editProjectDescriptionInput.value = project.description || '';
            .editProjectDeadlineDateInput.value = project.deadline || '';

            if (project.imageData) {
                .editProjectImagePreview.innerHTML = `<img src="${project.imageData}" alt="Preview">`;
            } else {
                .editProjectImagePreview.innerHTML = '';
            }
            .editProjectImageUploadInput.value = '';
            
            .editProjectForm.querySelector(`input[name="edit-project-status"][value="${project.status}"]`).checked = true;

        }
        function openAddNoteModal(forProjectId) {
            if (!forProjectId) { showToast("Project context required.", "error"); return; }
            openModal(.addNoteModal);
            .noteProjectIdInput.value = forProjectId;
        }

        // --- Form Submissions ---
        async function handleTaskFormSubmit(formEl, isEdit = false) {
            const id = isEdit ? .editTaskIdInput.value : generateId();
            const title = (isEdit ? .editTaskTitleInput : .taskTitleInput).value.trim();
            if (!title) { showToast('Task title is required.', 'error'); return; }

            const existingTask = isEdit ? tasks.find(t => t.id === id) : {};
            const taskData = {
                id: id,
                title: title,
                description: (isEdit ? .editTaskDescriptionInput : .taskDescriptionInput).value.trim(),
                projectId: (isEdit ? .editTaskProjectSelect : .taskProjectSelect).value || null,
                tags: (isEdit ? .editTaskTagsInput : .taskTagsInput).value.split(',').map(t => t.trim()).filter(t => t),
                deadline: (isEdit ? .editTaskDeadlineDateInput : .taskDeadlineDateInput).value || null,
                importance: formEl.querySelector(`input[name="${isEdit ? 'edit-' : ''}importance"]:checked`).value,
                status: formEl.querySelector(`input[name="${isEdit ? 'edit-' : ''}status"]:checked`).value,
                completed: existingTask?.completed || false,
                completedAt: existingTask?.completedAt || null,
                createdAt: existingTask?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            taskData.priority = calculatePriority(taskData);

            try {
                await putDexie(STORES.TASKS, taskData);
                if (isEdit) {
                    tasks = tasks.map(t => t.id === id ? taskData : t);
                } else {
                    tasks.push(taskData);
                }
                updateUniqueTags(taskData.tags);
                renderTasks();
                if (currentProjectId && taskData.projectId === currentProjectId) renderProjectTasks(currentProjectId);
                renderTagFilters(); renderManageTags();
                closeModal(isEdit ? .editTaskModal : .addTaskModal);
                showToast(isEdit ? 'Task updated!' : 'Task added!', 'success');
            } catch (error) { console.error("Error saving task:", error); showToast('Error saving task.', 'error'); }
        }
        async function handleProjectFormSubmit(formEl, isEdit = false) {
            const id = isEdit ? .editProjectIdInput.value : generateId();
            const title = (isEdit ? .editProjectTitleInput : .projectTitleInput).value.trim();
            if (!title) { showToast('Project title is required.', 'error'); return; }
            
            const imageUploadInput = isEdit ? .editProjectImageUploadInput : .projectImageUploadInput;
            let imageDataUrl = isEdit ? (projects.find(p=>p.id===id)?.imageData || null) : null; 

            if (imageUploadInput.files && imageUploadInput.files[0]) {
                try {
                    imageDataUrl = await readFileAsDataURL(imageUploadInput.files[0]);
                } catch (error) {
                    showToast('Error processing image.', 'error');
                    console.error("Image read error: ", error);
                    imageDataUrl = isEdit ? (projects.find(p=>p.id===id)?.imageData || null) : null; 
                }
            } else if (isEdit && !.editProjectImagePreview.querySelector('img')) { 
                imageDataUrl = null;
            }

            const existingProject = isEdit ? projects.find(p => p.id === id) : {};
            const projectData = {
                id: id,
                title: title,
                description: (isEdit ? .editProjectDescriptionInput : .projectDescriptionInput).value.trim(),
                imageData: imageDataUrl,
                deadline: (isEdit ? .editProjectDeadlineDateInput : .projectDeadlineDateInput).value || null,
                status: formEl.querySelector(`input[name="${isEdit ? 'edit-' : ''}project-status"]:checked`).value,
                folderId: isEdit ? existingProject.folderId : currentFolderId,
                createdAt: existingProject?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };


            try {
                await putDexie(STORES.PROJECTS, projectData);
                if (isEdit) {
                    projects = projects.map(p => p.id === id ? projectData : p);
                } else {
                    projects.push(projectData);
                }
                renderProjects(); renderProjectFilters();
                if (currentView === 'project-detail' && currentProjectId === id) renderProjectDetail(projectData); 
                closeModal(isEdit ? .editProjectModal : .addProjectModal);
                showToast(isEdit ? 'Project updated!' : 'Project added!', 'success');
            } catch (error) { console.error("Error saving project:", error); showToast('Error saving project.', 'error'); }
        }
        async function handleNoteFormSubmit(formEl) { 
            const projectId = .noteProjectIdInput.value;
            const title = .noteTitleInput.value.trim();
            const content = .noteContentInput.value.trim(); 
            const noteTagsRaw = .noteTagsInput.value.split(',').map(t => t.trim()).filter(t => t);

            if (!projectId || !title) { showToast('Project ID and Note Title are required.', 'error'); return; }

            const newNote = {
                id: generateId(),
                projectId: projectId,
                title: title,
                content: content, 
                tags: noteTagsRaw,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            try {
                await addDexie(STORES.NOTES, newNote);
                notes.push(newNote);
                updateUniqueTags(newNote.tags); 
                renderNotes(projectId);
                renderNoteTagFilters(projectId);
                closeModal(.addNoteModal);
                showToast('Note added to project!', 'success');
            } catch (error) { console.error("Error saving note:", error); showToast('Error saving note.', 'error');}
        }
        function setupFormDynamicBehavior(formEl, radioName, triggerVal, targetElId) {
            const targetEl = document.getElementById(targetElId);
            if (!targetEl) return;
            formEl.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === triggerVal && radio.checked) targetEl.classList.remove('hidden');
                    else targetEl.classList.add('hidden');
                });
            });
            const checkedRadio = formEl.querySelector(`input[name="${radioName}"]:checked`);
            if (checkedRadio && checkedRadio.value === triggerVal) targetEl.classList.remove('hidden');
            else targetEl.classList.add('hidden');
        }
        function handleImageUpload(inputElement, previewElement) {
            const file = inputElement.files[0];
            if (file) {
                if (!window.FileReader) { showToast('Image upload not supported', 'error'); return; }
                if (file.size > 2 * 1024 * 1024) {
                    showToast("Image size should be less than 2MB.", "warning");
                    inputElement.value = "";
                    previewElement.innerHTML = "";
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => { previewElement.innerHTML = `<img src="${e.target.result}" alt="Preview">`; };
                reader.readAsDataURL(file);
            } else {
                 previewElement.innerHTML = ""; 
            }
        }
        
        // --- View Management ---
        let previousView = 'active';
        function setCurrentView(view) {
            if (currentView === view && !['project-detail', 'concept-detail'].includes(view)) {
                // Ensure UI and data render even if view hasn't changed
                setCurrentViewUI(view);
                renderBasedOnView(view);
                return;
            }

            previousView = currentView;
            currentView = view;
            saveSetting('currentView', currentView);

            setCurrentViewUI(view);
            renderBasedOnView(view);
        }
        function setCurrentViewUI(view) {
            [.activeViewBtn, .waitingViewBtn, .completedViewBtn, .weeklyViewBtn, .quickTasksViewBtn, .projectsViewBtn, .conceptsViewBtn, .dataViewBtn].forEach(btn => btn.classList.remove('active'));
            // Hide all main content areas first
            [.tasksList, .quickTaskArea, .conceptArea, .weeklyArea, .projectsArea, .projectDetailView, .conceptDetailView, .dataArea].forEach(el => {
                if (el) el.classList.add('hidden'); // Ensure element exists before adding class
            });
            
            const mainContentEl = .mainContent; 
            if (['project-detail', 'concept-detail'].includes(view)) { 
                .sidebar.classList.add('hidden');
                mainContentEl.style.gridTemplateColumns = '1fr';
                 mainContentEl.classList.add('sidebar-hidden');
            } else {
                .sidebar.classList.remove('hidden');
                mainContentEl.style.gridTemplateColumns = ''; 
                mainContentEl.classList.remove('sidebar-hidden');
            }

            switch (view) {
                case 'active': .activeViewBtn.classList.add('active'); .tasksList.classList.remove('hidden'); break;
                case 'waiting': .waitingViewBtn.classList.add('active'); .tasksList.classList.remove('hidden'); break;
                case 'completed': .completedViewBtn.classList.add('active'); .tasksList.classList.remove('hidden'); break;
                case 'weekly': .weeklyViewBtn.classList.add('active'); .weeklyArea.classList.remove('hidden'); break;
                case 'quick': .quickTasksViewBtn.classList.add('active'); .quickTaskArea.classList.remove('hidden'); break;
                case 'concepts': .conceptsViewBtn.classList.add('active'); .conceptArea.classList.remove('hidden'); break;
                case 'concept-detail': .conceptsViewBtn.classList.add('active'); .conceptDetailView.classList.remove('hidden'); break;
                case 'projects': .projectsViewBtn.classList.add('active'); .projectsArea.classList.remove('hidden'); break;
                case 'project-detail': .projectsViewBtn.classList.add('active'); .projectDetailView.classList.remove('hidden'); break;
                case 'data': .dataViewBtn.classList.add('active'); .dataArea.classList.remove('hidden'); break;
            }
        }
        function renderBasedOnView(view) {
            switch (view) {
                case 'active': case 'waiting': case 'completed': renderTasks(); break;
                case 'quick': renderQuickTasks(); break;
                case 'weekly': renderWeeklyTasks(); break;
                case 'concepts': renderConcepts(); break;
                case 'concept-detail': /* Content rendered by openConceptDetailView */ break;
                case 'projects': renderProjects(); break;
                case 'project-detail': /* Content (tabs) rendered by openProjectDetail -> setActiveTab */ break;
                case 'data': updateLastBackupInfo(); break;
            }
        }
        function setActiveTab(tabName) {
            [.overviewTab, .tasksTab, .notesTab].forEach(tab => tab.classList.remove('active'));
            [.overviewContent, .tasksContent, .notesContent].forEach(content => content.classList.add('hidden'));

            switch (tabName) {
                case 'overview': 
                    .overviewTab.classList.add('active'); 
                    .overviewContent.classList.remove('hidden'); 
                    // Description should be up-to-date from renderProjectDetail
                    const proj = projects.find(p => p.id === currentProjectId);
                    if (proj) .projectDetailDescription.textContent = proj.description || 'No description provided.';
                    break;
                case 'tasks': 
                    .tasksTab.classList.add('active'); 
                    .tasksContent.classList.remove('hidden'); 
                    if(currentProjectId) renderProjectTasks(currentProjectId); 
                    break;
                case 'notes': 
                    .notesTab.classList.add('active'); 
                    .notesContent.classList.remove('hidden'); 
                    if(currentProjectId) { renderNotes(currentProjectId); renderNoteTagFilters(currentProjectId); }
                    break;
            }
        }

        // --- Specific Feature Functions (QuickTasks, Concepts, etc.) ---
        async function addQuickTask(text) {
            const newQTask = { id: generateId(), text: text, createdAt: new Date().toISOString() };
            quickTasks.push(newQTask);
            await addDexie(STORES.QUICK_TASKS, newQTask);
            renderQuickTasks();
            .quickTaskInput.value = '';
            showToast('Quick task added!', 'success');
        }
        function renderQuickTasks() {
            .quickTasksList.innerHTML = '';
            if(quickTasks.length === 0) {
                .quickTasksList.innerHTML = '<p style="font-size:0.9em; opacity:0.7; text-align:center; padding:10px;">No quick tasks. Add one above!</p>'; return;
            }
            quickTasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach((qTask, i) => {
                const el = document.createElement('div');
                el.className = 'quick-task-item';
                el.style.animationDelay = `${i * 0.03}s`;
                el.innerHTML = `
                    <span class="quick-task-text">${truncateText(qTask.text, 100)}</span>
                    <div class="quick-task-actions">
                        <button class="quick-task-action-btn process-btn" title="Process to Full Task"><i class="fas fa-share-square"></i></button>
                        <button class="quick-task-action-btn delete-btn" title="Delete Quick Task"><i class="fas fa-trash-alt"></i></button>
                    </div>`;
                el.querySelector('.process-btn').addEventListener('click', () => processQuickTask(qTask.id));
                el.querySelector('.delete-btn').addEventListener('click', () => deleteQuickTask(qTask.id));
                .quickTasksList.appendChild(el);
            });
        }
        async function deleteQuickTask(id) {
            quickTasks = quickTasks.filter(qt => qt.id !== id);
            await deleteDexieItem(STORES.QUICK_TASKS, id);
            renderQuickTasks();
            showToast('Quick task deleted.', 'success');
        }
        function processQuickTask(id) {
            const qTask = quickTasks.find(qt => qt.id === id);
            if (!qTask) return;
            openAddTaskModal(); 
            .taskTitleInput.value = qTask.text; 
            deleteQuickTask(id);
            showToast('Quick task moved to new task form.', 'info');
        }
        async function saveConcept() {
            const title = .conceptTitleInput.value.trim();
            const text = .conceptInput.value.trim();
            if (!title && !text) { showToast('Concept title or text is required.', 'warning'); return; }
            const newConcept = { 
                id: generateId(), 
                title: title || "Untitled Concept", 
                text: text, 
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            concepts.push(newConcept);
            await addDexie(STORES.CONCEPTS, newConcept);
            renderConcepts();
            .conceptTitleInput.value = ''; .conceptInput.value = '';
            showToast('Concept saved!', 'success');
        }
        async function workOutConcept() { 
            const title = .conceptTitleInput.value.trim();
            const text = .conceptInput.value.trim();
            let conceptToOpen;
            if (title || text) { 
                conceptToOpen = { 
                    id: generateId(), title: title || "Untitled Concept", text: text, 
                    createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() 
                };
                concepts.push(conceptToOpen);
                await addDexie(STORES.CONCEPTS, conceptToOpen);
                .conceptTitleInput.value = ''; .conceptInput.value = '';
                renderConcepts();
            } else if (concepts.length > 0) { 
                conceptToOpen = concepts.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))[0];
            } else {
                showToast('No concepts to work out. Create one first.', 'info'); return;
            }
            if (conceptToOpen) openConceptDetailView(conceptToOpen.id);
        }
        function renderConcepts() {
            .conceptsList.innerHTML = '';
            if (concepts.length === 0) {
                 .conceptsList.innerHTML = '<p style="font-size:0.9em; opacity:0.7; text-align:center; padding:10px;">No concepts yet. Jot some ideas down!</p>'; return;
            }
            concepts.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach((concept, i) => {
                const el = document.createElement('div');
                el.className = 'concept-item';
                el.dataset.id = concept.id;
                el.style.animationDelay = `${i * 0.03}s`;
                el.innerHTML = `
                    <div class="concept-header">
                        <h5 class="concept-title">${truncateText(concept.title, 40)}</h5>
                        <span class="concept-date">${formatDate(concept.updatedAt)}</span>
                    </div>
                    <p class="concept-preview">${truncateText(concept.text, 120)}</p>
                    <div class="concept-actions">
                        <button class="concept-action-btn view-concept-btn action-btn" title="View/Edit Concept"><i class="fas fa-eye"></i></button>
                         <button class="concept-action-btn convert-to-project-btn action-btn" title="Convert to Project"><i class="fas fa-share-square"></i></button>
                    </div>`;
                el.querySelector('.view-concept-btn').addEventListener('click', (e) => { e.stopPropagation(); openConceptDetailView(concept.id); });
                el.querySelector('.convert-to-project-btn').addEventListener('click', (e) => { e.stopPropagation(); convertConceptToProject(concept.id); });
                .conceptsList.appendChild(el);
            });
        }
        function openConceptDetailView(id) {
            const concept = concepts.find(c => c.id === id);
            if (!concept) { showToast('Concept not found.', 'error'); return; }
            currentConceptId = id;
            .conceptDetailTitle.textContent = concept.title;
            .conceptDetailDate.textContent = `Last updated: ${formatDateTime(concept.updatedAt)}`;
            .conceptDetailText.value = concept.text;
            setCurrentView('concept-detail'); // This will remove .hidden from conceptDetailView
        }
        async function saveConceptDetail() { 
            if (!currentConceptId) return;
            const conceptIndex = concepts.findIndex(c => c.id === currentConceptId);
            if (conceptIndex === -1) { showToast('Error saving: concept not found.', 'error'); return; }
            
            concepts[conceptIndex].title = .conceptDetailTitle.textContent.trim() || "Untitled Concept";
            concepts[conceptIndex].text = .conceptDetailText.value;
            concepts[conceptIndex].updatedAt = new Date().toISOString();
            
            await putDexie(STORES.CONCEPTS, concepts[conceptIndex]);
            renderConcepts(); 
            if(currentView === 'concept-detail' && currentConceptId === concepts[conceptIndex].id) {
                 .conceptDetailDate.textContent = `Last updated: ${formatDateTime(concepts[conceptIndex].updatedAt)}`;
            }
            showToast('Concept updated!', 'success');
        }
        async function deleteConcept(id, isConversion = false) { 
            const conceptToDelete = concepts.find(c => c.id === id);
            if (!conceptToDelete) {
                if(!isConversion) showToast("Concept not found for deletion.", "error");
                return;
            }
            if (!isConversion && !confirm(`Are you sure you want to delete the concept "${truncateText(conceptToDelete.title, 30)}"?`)) return;
            
            concepts = concepts.filter(c => c.id !== id);
            await deleteDexieItem(STORES.CONCEPTS, id);
            
            renderConcepts(); // Always re-render the list
            if (!isConversion) {
                if (currentView === 'concept-detail' && currentConceptId === id) {
                    setCurrentView('concepts'); 
                }
                showToast('Concept deleted.', 'success');
            }
            // If it's a conversion, the calling function (convertConceptToProject) will handle user feedback
        }
        async function convertConceptToProject(conceptId) {
            const concept = concepts.find(c => c.id === conceptId);
            if (!concept) { showToast('Concept not found.', 'error'); return; }
            openAddProjectModal();
            .projectTitleInput.value = concept.title;
            .projectDescriptionInput.value = concept.text; 
            
            await deleteConcept(conceptId, true); // Pass true to indicate it's part of a conversion

            showToast(`"${truncateText(concept.title,20)}" ready for project creation. Original concept removed.`, 'info');
        }
        async function clearCompletedTasks() {
            const completedTasks = tasks.filter(t => t.completed);
            if (completedTasks.length === 0) { showToast('No completed tasks to clear.', 'info'); return; }
            if (!confirm(`Are you sure you want to delete ${completedTasks.length} completed task(s)?`)) return;
            
            const completedTaskIds = completedTasks.map(t => t.id);
            tasks = tasks.filter(t => !t.completed);
            await db.table(STORES.TASKS).bulkDelete(completedTaskIds);
            renderTasks();
            if (currentView === 'project-detail' && currentProjectId) renderProjectTasks(currentProjectId);
            showToast(`${completedTaskIds.length} completed task(s) cleared.`, 'success');
        }

        async function backupData() {
            const data = await window.__collectForCloud();
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finaflow-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            lastBackup = new Date().toISOString();
            await saveSetting('lastBackup', lastBackup);
            updateLastBackupInfo();
            showToast('Backup created.', 'success');
        }

        function updateLastBackupInfo() {
            if (.lastBackupInfo) {
                .lastBackupInfo.textContent = lastBackup ? `Last backup: ${formatDateTime(lastBackup)}` : 'No backups yet.';
            }
        }

        async function handleRestoreFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                await window.__renderFromCloud(data);
                showToast('Backup restored.', 'success');
            } catch (err) {
                console.error(err);
                showToast('Failed to restore backup.', 'error');
            } finally {
                event.target.value = '';
            }
        }
        
        
        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // View Controls
            .activeViewBtn.addEventListener('click', () => setCurrentView('active'));
            .waitingViewBtn.addEventListener('click', () => setCurrentView('waiting'));
            .completedViewBtn.addEventListener('click', () => setCurrentView('completed'));
            .weeklyViewBtn.addEventListener('click', () => setCurrentView('weekly'));
            .quickTasksViewBtn.addEventListener('click', () => setCurrentView('quick'));
            .projectsViewBtn.addEventListener('click', () => setCurrentView('projects'));
            .conceptsViewBtn.addEventListener('click', () => setCurrentView('concepts'));
            .dataViewBtn.addEventListener('click', () => setCurrentView('data'));

            // Sidebar
            .sortSelect.addEventListener('change', e => { currentSort = e.target.value; saveSetting('currentSort', currentSort); renderTasks(); });
            
            // Action Toolbar
            .addTaskBtn.addEventListener('click', () => openAddTaskModal());
            .quickAddBtn.addEventListener('click', () => { setCurrentView('quick'); .quickTaskInput.focus(); });
            .newProjectBtn.addEventListener('click', () => openAddProjectModal());
            .newConceptBtn.addEventListener('click', () => { setCurrentView('concepts'); .conceptTitleInput.focus(); });
            .clearCompletedBtn.addEventListener('click', clearCompletedTasks);

            .addWeeklyTaskBtn.addEventListener('click', openAddWeeklyTaskModal);
            .weeklyHistoryBtn.addEventListener('click', showWeeklyHistory);

            // Quick Tasks
            .quickTaskInput.addEventListener('keypress', e => { if (e.key === 'Enter' && .quickTaskInput.value.trim()) addQuickTask(.quickTaskInput.value.trim()); });
            .closeQuickTaskBtn.addEventListener('click', () => setCurrentView(previousView === 'quick' ? 'active' : previousView));


            // Concepts
            .saveConceptBtn.addEventListener('click', saveConcept);
            .workOutConceptBtn.addEventListener('click', workOutConcept);
            .closeConceptBtn.addEventListener('click', () => setCurrentView(previousView === 'concepts' ? 'active' : previousView));
            .conceptDetailTitle.addEventListener('blur', saveConceptDetail); 
            .conceptDetailText.addEventListener('blur', saveConceptDetail);   
            .saveConceptDetailBtn.addEventListener('click', saveConceptDetail);
            .backToConceptsBtn.addEventListener('click', () => setCurrentView('concepts'));
            .deleteConceptBtn.addEventListener('click', () => { if(currentConceptId) deleteConcept(currentConceptId, false); });
            .conceptToProjectBtn.addEventListener('click', () => { if(currentConceptId) convertConceptToProject(currentConceptId); });


            // Projects View
            .gridViewBtn.addEventListener('click', () => setProjectsViewMode('grid'));
            .listViewBtn.addEventListener('click', () => setProjectsViewMode('list'));
            .projectSearchInput.addEventListener('input', renderProjects);
            .projectStatusFilter.addEventListener('change', renderProjects);
            .addFolderBtn.addEventListener('click', () => addFolder());
            .backFolderBtn.addEventListener('click', () => { currentFolderId = folders.find(f=>f.id===currentFolderId)?.parentId || null; renderProjects(); });
            .backFolderBtn.addEventListener('dragover', e => e.preventDefault());
            .backFolderBtn.addEventListener('drop', e => { const pid = e.dataTransfer.getData('text/plain'); const parentId = folders.find(f=>f.id===currentFolderId)?.parentId || null; moveProjectToFolder(pid, parentId); });
            .renameFolderBtn.addEventListener('click', () => { if(currentFolderId) renameFolder(currentFolderId); });
            .deleteFolderBtn.addEventListener('click', () => { if(currentFolderId) deleteFolder(currentFolderId); });

            // Project Detail View
            .backToProjectsBtn.addEventListener('click', () => setCurrentView('projects'));
            .editProjectDetailBtn.addEventListener('click', () => { if(currentProjectId) openEditProjectModal(currentProjectId); });
            .deleteProjectDetailBtn.addEventListener('click', () => { if(currentProjectId) deleteProject(currentProjectId, false); });
            .overviewTab.addEventListener('click', () => setActiveTab('overview'));
            .tasksTab.addEventListener('click', () => setActiveTab('tasks'));
            .notesTab.addEventListener('click', () => setActiveTab('notes'));
            .addProjectTaskBtn.addEventListener('click', () => { if(currentProjectId) openAddTaskModal(currentProjectId); });
            .addNoteBtn.addEventListener('click', () => { if(currentProjectId) openAddNoteModal(currentProjectId); });
            .notesSortSelect.addEventListener('change', () => { notesSort = .notesSortSelect.value; saveSetting('notesSort', notesSort); if (currentProjectId) renderNotes(currentProjectId); });


            // Modals General
            allModalCloseBtns.forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
            allModalCancelBtns.forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
            window.addEventListener('click', e => { if (e.target.classList.contains('modal') && e.target.classList.contains('visible')) closeModal(e.target);});
            window.addEventListener('keydown', e => { if (e.key === 'Escape') { document.querySelectorAll('.modal.visible').forEach(closeModal); if(.noteEditorOverlay.classList.contains('visible')) closeNoteEditor(); } });

            // Task Form (Add & Edit)
            .taskForm.addEventListener('submit', e => { e.preventDefault(); handleTaskFormSubmit(.taskForm, false); });
            .editTaskForm.addEventListener('submit', e => { e.preventDefault(); handleTaskFormSubmit(.editTaskForm, true); });
            .deleteTaskBtn.addEventListener('click', () => { if(.editTaskIdInput.value) deleteTask(.editTaskIdInput.value, true); });
            [.taskTagsInput, .editTaskTagsInput].forEach(input => {
                input.addEventListener('focus', () => {
                    const container = input.id === 'task-tags' ? .suggestedTagsContainer : .editSuggestedTagsContainer;
                    renderSuggestedTags(input.value.split(',').map(t => t.trim()).filter(t => t), container, input);
                });
                 input.addEventListener('input', () => { 
                    const container = input.id === 'task-tags' ? .suggestedTagsContainer : .editSuggestedTagsContainer;
                    renderSuggestedTags(input.value.split(',').map(t => t.trim()).filter(t => t), container, input);
                });
            });


            // Project Form (Add & Edit)
            .projectForm.addEventListener('submit', e => { e.preventDefault(); handleProjectFormSubmit(.projectForm, false); });
            .editProjectForm.addEventListener('submit', e => { e.preventDefault(); handleProjectFormSubmit(.editProjectForm, true); });
            .deleteProjectModalBtn.addEventListener('click', () => { if(.editProjectIdInput.value) deleteProject(.editProjectIdInput.value, true); });
            .projectImageUploadInput.addEventListener('change', () => handleImageUpload(.projectImageUploadInput, .projectImagePreview));
            .editProjectImageUploadInput.addEventListener('change', () => handleImageUpload(.editProjectImageUploadInput, .editProjectImagePreview));



            // Note Form (Simple Add Modal)
            .noteForm.addEventListener('submit', e => { e.preventDefault(); handleNoteFormSubmit(.noteForm); });

            .weeklyTaskForm.addEventListener('submit', e => { e.preventDefault(); handleWeeklyTaskFormSubmit(false); });
            .editWeeklyTaskForm.addEventListener('submit', e => { e.preventDefault(); handleWeeklyTaskFormSubmit(true); });
            .deleteWeeklyTaskBtn.addEventListener('click', () => { if(.editWeeklyIdInput.value) { deleteWeeklyTask(.editWeeklyIdInput.value); closeModal(.editWeeklyTaskModal); } });

            // Quill Note Editor
            .closeNoteEditorBtn.addEventListener('click', closeNoteEditor);
            .saveEditedNoteBtn.addEventListener('click', saveEditedNote);
            .deleteCurrentNoteBtn.addEventListener('click', deleteCurrentNoteFromEditor);

            .backupBtn.addEventListener('click', backupData);
            .restoreBtn.addEventListener('click', () => .restoreInput.click());
            .restoreInput.addEventListener('change', handleRestoreFile);

        }
        function populateProjectSelect(selectElement) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = '<option value="">-- None --</option>';
            projects
                .filter(p => p.status !== 'completed' && p.status !== 'storage')
                .sort((a,b) => a.title.localeCompare(b.title))
                .forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.title;
                    selectElement.appendChild(option);
                });
            if (Array.from(selectElement.options).some(opt => opt.value === currentValue)) {
                 selectElement.value = currentValue;
            } else {
                selectElement.value = ""; 
            }
        }
        function renderSuggestedTags(currentTaskTags, container, inputElement) {
            container.innerHTML = '';
            const availableTags = tags.filter(t => !currentTaskTags.includes(t));
            availableTags.slice(0, 10).forEach(tag => {
                const el = document.createElement('button');
                el.type = 'button';
                el.className = 'suggested-tag';
                el.textContent = tag;
                el.addEventListener('click', () => {
                    let currentTags = inputElement.value.split(',').map(t => t.trim()).filter(t => t);
                    if (!currentTags.includes(tag)) {
                        currentTags.push(tag);
                        inputElement.value = currentTags.join(', ');
                        renderSuggestedTags(currentTags, container, inputElement);
                    }
                });
                container.appendChild(el);
            });
        }

        // --- Initialization ---
        async function init() {
            if (!window.Dexie) {
                console.error('Dexie library failed to load.');
                return;
            }
            db = new Dexie('finaTaskManager');
            db.version(5).stores({
                tasks: 'id, projectId, status, *tags, completed, priority, deadline, createdAt',
                quickTasks: 'id, createdAt',
                tags: 'tag',
                projects: 'id, status, title, deadline, createdAt',
                concepts: 'id, createdAt, title, updatedAt',
                notes: 'id, projectId, *tags, updatedAt, title, createdAt',
                settings: 'key',
                folders: 'id,parentId,createdAt',
                weeklyTasks: 'id',
                weeklyLogs: '[taskId+weekStart],weekStart'
            });
            window.finaDB = db;
            window.save = () => {};

            window.__collectForCloud = async () => {
                const dexie = window.finaDB;
                const data = {};
                if (dexie) {
                    for (const table of dexie.tables) {
                        data[table.name] = await table.toArray();
                    }
                }
                return data;
            };

            window.__renderFromCloud = async (data) => {
                const dexie = window.finaDB;
                if (!dexie || !data) return;
                for (const table of dexie.tables) {
                    if (data[table.name]) {
                        await dexie.table(table.name).clear();
                        if (data[table.name].length) {
                            await dexie.table(table.name).bulkPut(data[table.name]);
                        }
                    }
                }
                await loadDataFromDB();
                setCurrentView(currentView || "active");
                if (.sortSelect) .sortSelect.value = currentSort || "priority";
                setProjectsViewMode(projectsViewMode || "grid");
                if (.notesSortSelect) .notesSortSelect.value = notesSort || "date";
                renderTagFilters();
                renderProjectFilters();
                renderManageTags();
                updateAllTaskPriorities(false);
                if (currentProjectId && document.getElementById("project-detail").classList.contains("visible")) {
                    const proj = projects.find(p => p.id === currentProjectId);
                    if (proj) openProjectDetail(currentProjectId); else setCurrentView("projects");
                }
                if (currentConceptId && document.getElementById("concept-detail").classList.contains("visible")) {
                    const conc = concepts.find(c => c.id === currentConceptId);
                    if (conc) openConceptDetailView(currentConceptId); else setCurrentView("concepts");
                }
            };


            await loadDataFromDB();
            populateProjectSelect(.taskProjectSelect);
            populateProjectSelect(.editTaskProjectSelect);
            initializeQuillEditor();
            setupEventListeners();
            
            setCurrentView(currentView || 'active'); 
            .sortSelect.value = currentSort || 'priority';
            setProjectsViewMode(projectsViewMode || 'grid');
            if (.notesSortSelect) .notesSortSelect.value = notesSort || 'date';

            renderTagFilters(); 
            renderProjectFilters(); 
            renderManageTags();
            renderWeeklyTasks();
            updateAllTaskPriorities(true);
            updateLastBackupInfo();

            console.log('Task Manager Initialized.');
            showToast('Welcome back to Task Manager!', 'info', 2000);
        }
    document.addEventListener('DOMContentLoaded', init);

})();
    </script>


<!-- DEBUG LAYER -->
<script>
(function(){
  const debug = window.debug = {};
  const now = new Date().toISOString();
  // console.log('%cDebugging enabled  '+now, 'background:#2c3e50;color:#ecf0f1;padding:4px;border-radius:4px;');

  window.addEventListener('error', function(e){
      console.error('[GLOBAL ERROR]', e.error || e.message, e.filename + ':' + e.lineno + ':' + e.colno, e);
  });
  window.addEventListener('unhandledrejection', function(e){
      console.error('[UNHANDLED PROMISE]', e.reason);
  });

  if (window.Dexie) { 
      const ioMethods = ['get','put','add','delete','bulkPut', 'bulkDelete', 'clear'];
      ioMethods.forEach(method=>{
         if (window.Dexie.Table && window.Dexie.Table.prototype && typeof window.Dexie.Table.prototype[method] === 'function') { // Ensure method exists
             const orig = window.Dexie.Table.prototype[method];
             window.Dexie.Table.prototype[method] = function(...args){
                // console.log(`[DEXIE TABLE:${this.name}] ${method}`, args.length > 0 ? args[0] : '');
                 return orig.apply(this, args);
             };
         }
      });
  } else {
      // console.warn("Dexie not loaded when debug script ran. Dexie spy not attached.");
  }
  
  debug.dumpState = ()=>{
      const stateSnapshot = {
          tasks: typeof window.tasks !== 'undefined' ? window.tasks : 'N/A',
          quickTasks: typeof window.quickTasks !== 'undefined' ? window.quickTasks : 'N/A',
          tags: typeof window.tags !== 'undefined' ? window.tags : 'N/A',
          projects: typeof window.projects !== 'undefined' ? window.projects : 'N/A',
          concepts: typeof window.concepts !== 'undefined' ? window.concepts : 'N/A',
          notes: typeof window.notes !== 'undefined' ? window.notes : 'N/A',
          currentView: typeof window.currentView !== 'undefined' ? window.currentView : 'N/A',
          currentSort: typeof window.currentSort !== 'undefined' ? window.currentSort : 'N/A',
          activeFilters: typeof window.activeFilters !== 'undefined' ? window.activeFilters : 'N/A',
          noteActiveFilters: typeof window.noteActiveFilters !== 'undefined' ? window.noteActiveFilters : 'N/A',
          projectFilters: typeof window.projectFilters !== 'undefined' ? window.projectFilters : 'N/A',
          currentProjectId: typeof window.currentProjectId !== 'undefined' ? window.currentProjectId : 'N/A',
          currentConceptId: typeof window.currentConceptId !== 'undefined' ? window.currentConceptId : 'N/A',
          currentEditingNoteId: typeof window.currentEditingNoteId !== 'undefined' ? window.currentEditingNoteId : 'N/A',
          projectsViewMode: typeof window.projectsViewMode !== 'undefined' ? window.projectsViewMode : 'N/A',
          notesSort: typeof window.notesSort !== 'undefined' ? window.notesSort : 'N/A'
      };
      console.log('[STATE SNAPSHOT]', stateSnapshot);
      return stateSnapshot;
  };
})();
</script>
</body>
</html>
